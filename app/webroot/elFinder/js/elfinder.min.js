/*!
 * elFinder - file manager for web
 * Version 2.0 rc1 (2012-06-11)
 * http://elfinder.org
 * 
 * Copyright 2009-2012, Studio 42
 * Licensed under a 3 clauses BSD license
 */
(function($){window.elFinder=function(node,opts){this.time("load");var self=this,node=$(node),prevContent=$("<div/>").append(node.contents()),prevStyle=node.attr("style"),id=node.attr("id")||"",namespace="elfinder-"+(id||Math.random().toString().substr(2,7)),mousedown="mousedown."+namespace,keydown="keydown."+namespace,keypress="keypress."+namespace,enabled=!0,prevEnabled=!0,events=["enable","disable","load","open","reload","select","add","remove","change","dblclick","getfile","lockfiles","unlockfiles","dragstart","dragstop"],rules={},cwd="",cwdOptions={path:"",url:"",tmbUrl:"",disabled:[],separator:"/",archives:[],extract:[],copyOverwrite:!0,tmb:!1},files={},selected=[],listeners={},shortcuts={},clipboard=[],remember=[],queue=[],base=new self.command(self),width="auto",height=400,beeper=$(document.createElement("audio")).hide().appendTo("body")[0],syncInterval,open=function(data){if(data.init)files={};else for(var i in files)files.hasOwnProperty(i)&&files[i].mime!="directory"&&files[i].phash==cwd&&$.inArray(i,remember)===-1&&delete files[i];cwd=data.cwd.hash,cache(data.files),files[cwd]||cache([data.cwd]),self.lastDir(cwd)},cache=function(data){var l=data.length,f;while(l--)f=data[l],f.name&&f.hash&&f.mime&&(files[f.hash]=f)},execShortcut=function(e){var code=e.keyCode,ctrlKey=!!e.ctrlKey||!!e.metaKey;enabled&&($.each(shortcuts,function(i,shortcut){shortcut.type==e.type&&shortcut.keyCode==code&&shortcut.shiftKey==e.shiftKey&&shortcut.ctrlKey==ctrlKey&&shortcut.altKey==e.altKey&&(e.preventDefault(),e.stopPropagation(),shortcut.callback(e,self),self.debug("shortcut-exec",i+" : "+shortcut.description))}),code==9&&!$(e.target).is(":input")&&e.preventDefault())},date=new Date,utc,i18n;this.api=null,this.newAPI=!1,this.oldAPI=!1,this.OS=navigator.userAgent.indexOf("Mac")!==-1?"mac":navigator.userAgent.indexOf("Win")!==-1?"win":"other",this.options=$.extend(!0,{},this._options,opts||{}),opts.ui&&(this.options.ui=opts.ui),opts.commands&&(this.options.commands=opts.commands),opts.uiOptions&&opts.uiOptions.toolbar&&(this.options.uiOptions.toolbar=opts.uiOptions.toolbar),$.extend(this.options.contextmenu,opts.contextmenu),this.requestType=/^(get|post)$/i.test(this.options.requestType)?this.options.requestType.toLowerCase():"get",this.customData=$.isPlainObject(this.options.customData)?this.options.customData:{},this.id=id,this.uploadURL=opts.urlUpload||opts.url,this.namespace=namespace,this.lang=this.i18[this.options.lang]&&this.i18[this.options.lang].messages?this.options.lang:"en",i18n=this.lang=="en"?this.i18.en:$.extend(!0,{},this.i18.en,this.i18[this.lang]),this.direction=i18n.direction,this.messages=i18n.messages,this.dateFormat=this.options.dateFormat||i18n.dateFormat,this.fancyFormat=this.options.fancyDateFormat||i18n.fancyDateFormat,this.today=(new Date(date.getFullYear(),date.getMonth(),date.getDate())).getTime()/1e3,this.yesterday=this.today-86400,utc=this.options.UTCDate?"UTC":"",this.getHours="get"+utc+"Hours",this.getMinutes="get"+utc+"Minutes",this.getSeconds="get"+utc+"Seconds",this.getDate="get"+utc+"Date",this.getDay="get"+utc+"Day",this.getMonth="get"+utc+"Month",this.getFullYear="get"+utc+"FullYear",this.cssClass="ui-helper-reset ui-helper-clearfix ui-widget ui-widget-content ui-corner-all elfinder elfinder-"+(this.direction=="rtl"?"rtl":"ltr")+" "+this.options.cssClass,this.storage=function(){try{return"localStorage"in window&&window.localStorage!==null?self.localStorage:self.cookie}catch(e){return self.cookie}}(),this.viewType=this.storage("view")||this.options.defaultView||"icons",this.notifyDelay=this.options.notifyDelay>0?parseInt(this.options.notifyDelay):500,this.draggable={appendTo:"body",addClasses:!0,delay:30,revert:!0,refreshPositions:!0,cursor:"move",cursorAt:{left:50,top:47},drag:function(e,ui){ui.helper.data("locked")||ui.helper.toggleClass("elfinder-drag-helper-plus",e.shiftKey||e.ctrlKey||e.metaKey)},start:function(e,ui){var targets=$.map(ui.helper.data("files")||[],function(h){return h||null}),cnt,h;cnt=targets.length;while(cnt--){h=targets[cnt];if(files[h].locked){ui.helper.addClass("elfinder-drag-helper-plus").data("locked",!0);break}}},stop:function(){self.trigger("focus").trigger("dragstop")},helper:function(e,ui){var element=this.id?$(this):$(this).parents("[id]:first"),helper=$('<div class="elfinder-drag-helper"><span class="elfinder-drag-helper-icon-plus"/></div>'),icon=function(mime){return'<div class="elfinder-cwd-icon '+self.mime2class(mime)+' ui-corner-all"/>'},hashes,l;return self.trigger("dragstart",{target:element[0],originalEvent:e}),hashes=element.is("."+self.res("class","cwdfile"))?self.selected():[self.navId2Hash(element.attr("id"))],helper.append(icon(files[hashes[0]].mime)).data("files",hashes).data("locked",!1),(l=hashes.length)>1&&helper.append(icon(files[hashes[l-1]].mime)+'<span class="elfinder-drag-num">'+l+"</span>"),helper}},this.droppable={tolerance:"pointer",accept:".elfinder-cwd-file-wrapper,.elfinder-navbar-dir,.elfinder-cwd-file",hoverClass:this.res("class","adroppable"),drop:function(e,ui){var dst=$(this),targets=$.map(ui.helper.data("files")||[],function(h){return h||null}),result=[],c="class",cnt,hash,i,h;dst.is("."+self.res(c,"cwd"))?hash=cwd:dst.is("."+self.res(c,"cwdfile"))?hash=dst.attr("id"):dst.is("."+self.res(c,"navdir"))&&(hash=self.navId2Hash(dst.attr("id"))),cnt=targets.length;while(cnt--)h=targets[cnt],h!=hash&&files[h].phash!=hash&&result.push(h);result.length&&(ui.helper.hide(),self.clipboard(result,!(e.ctrlKey||e.shiftKey||e.metaKey||ui.helper.data("locked"))),self.exec("paste",hash),self.trigger("drop",{files:targets}))}},this.enabled=function(){return node.is(":visible")&&enabled},this.visible=function(){return node.is(":visible")},this.root=function(hash){var dir=files[hash||cwd],i;while(dir&&dir.phash)dir=files[dir.phash];if(dir)return dir.hash;while(i in files&&files.hasOwnProperty(i)){dir=files[i];if(!dir.phash&&!dir.mime=="directory"&&dir.read)return dir.hash}return""},this.cwd=function(){return files[cwd]||{}},this.option=function(name){return cwdOptions[name]||""},this.file=function(hash){return files[hash]},this.files=function(){return $.extend(!0,{},files)},this.parents=function(hash){var parents=[],dir;while(dir=this.file(hash))parents.unshift(dir.hash),hash=dir.phash;return parents},this.path2array=function(hash){var file,path=[];while(hash&&(file=files[hash])&&file.hash)path.unshift(file.name),hash=file.phash;return path},this.path=function(hash){return files[hash]&&files[hash].path?files[hash].path:this.path2array(hash).join(cwdOptions.separator)},this.url=function(hash){var file=files[hash];if(!file||!file.read)return"";if(file.url)return file.url;if(cwdOptions.url)return cwdOptions.url+$.map(this.path2array(hash),function(n){return encodeURIComponent(n)}).slice(1).join("/");var params=$.extend({},this.customData,{cmd:"file",target:file.hash});return this.oldAPI&&(params.cmd="open",params.current=file.phash),this.options.url+(this.options.url.indexOf("?")===-1?"?":"&")+$.param(params,!0)},this.tmb=function(hash){var file=files[hash],url=file&&file.tmb&&file.tmb!=1?cwdOptions.tmbUrl+file.tmb:"";return url&&($.browser.opera||$.browser.msie)&&(url+="?_="+(new Date).getTime()),url},this.selected=function(){return selected.slice(0)},this.selectedFiles=function(){return $.map(selected,function(hash){return files[hash]?$.extend({},files[hash]):null})},this.fileByName=function(name,phash){var hash;for(hash in files)if(files.hasOwnProperty(hash)&&files[hash].phash==phash&&files[hash].name==name)return files[hash]},this.validResponse=function(cmd,data){return data.error||this.rules[this.rules[cmd]?cmd:"defaults"](data)},this.request=function(options){var self=this,o=this.options,dfrd=$.Deferred(),data=$.extend({},o.customData,{mimes:o.onlyMimes},options.data||options),cmd=data.cmd,deffail=!options.preventDefault&&!options.preventFail,defdone=!options.preventDefault&&!options.preventDone,notify=$.extend({},options.notify),raw=!!options.raw,syncOnFail=options.syncOnFail,timeout,options=$.extend({url:o.url,async:!0,type:this.requestType,dataType:"json",cache:!1,data:data},options.options||{}),done=function(data){data.warning&&self.error(data.warning),cmd=="open"&&
open($.extend(!0,{},data)),data.removed&&data.removed.length&&self.remove(data),data.added&&data.added.length&&self.add(data),data.changed&&data.changed.length&&self.change(data),self.trigger(cmd,data),data.sync&&self.sync()},error=function(xhr,status){var error;switch(status){case"abort":error=xhr.quiet?"":["errConnect","errAbort"];break;case"timeout":error=["errConnect","errTimeout"];break;case"parsererror":error=["errResponse","errDataNotJSON"];break;default:xhr.status==403?error=["errConnect","errAccess"]:xhr.status==404?error=["errConnect","errNotFound"]:error="errConnect"}dfrd.reject(error,xhr,status)},success=function(response){if(raw)return dfrd.resolve(response);if(!response)return dfrd.reject(["errResponse","errDataEmpty"],xhr);if(!$.isPlainObject(response))return dfrd.reject(["errResponse","errDataNotJSON"],xhr);if(response.error)return dfrd.reject(response.error,xhr);if(!self.validResponse(cmd,response))return dfrd.reject("errResponse",xhr);response=self.normalize(response),self.api||(self.api=response.api||1,self.newAPI=self.api>=2,self.oldAPI=!self.newAPI),response.options&&(cwdOptions=$.extend({},cwdOptions,response.options)),response.netDrivers&&(self.netDrivers=response.netDrivers),dfrd.resolve(response),response.debug&&self.debug("backend-debug",response.debug)},xhr,_xhr;defdone&&dfrd.done(done),dfrd.fail(function(error){error&&(deffail?self.error(error):self.debug("error",self.i18n(error)))});if(!cmd)return dfrd.reject("errCmdReq");syncOnFail&&dfrd.fail(function(error){error&&self.sync()}),notify.type&&notify.cnt&&(timeout=setTimeout(function(){self.notify(notify),dfrd.always(function(){notify.cnt=-(parseInt(notify.cnt)||0),self.notify(notify)})},self.notifyDelay),dfrd.always(function(){clearTimeout(timeout)}));if(cmd=="open")while(_xhr=queue.pop())!_xhr.isRejected()&&!_xhr.isResolved()&&(_xhr.quiet=!0,_xhr.abort());return delete options.preventFail,xhr=this.transport.send(options).fail(error).done(success),cmd=="open"&&(queue.unshift(xhr),dfrd.always(function(){var ndx=$.inArray(xhr,queue);ndx!==-1&&queue.splice(ndx,1)})),dfrd},this.diff=function(incoming){var raw={},added=[],removed=[],changed=[],isChanged=function(hash){var l=changed.length;while(l--)if(changed[l].hash==hash)return!0};return $.each(incoming,function(i,f){raw[f.hash]=f}),$.each(files,function(hash,f){!raw[hash]&&removed.push(hash)}),$.each(raw,function(hash,file){var origin=files[hash];origin?$.each(file,function(prop){if(file[prop]!=origin[prop])return changed.push(file),!1}):added.push(file)}),$.each(removed,function(i,hash){var file=files[hash],phash=file.phash;phash&&file.mime=="directory"&&$.inArray(phash,removed)===-1&&raw[phash]&&!isChanged(phash)&&changed.push(raw[phash])}),{added:added,removed:removed,changed:changed}},this.sync=function(){var self=this,dfrd=$.Deferred().done(function(){self.trigger("sync")}),opts1={data:{cmd:"open",init:1,target:cwd,tree:this.ui.tree?1:0},preventDefault:!0},opts2={data:{cmd:"parents",target:cwd},preventDefault:!0};return $.when(this.request(opts1),this.request(opts2)).fail(function(error){dfrd.reject(error),error&&self.request({data:{cmd:"open",target:self.lastDir(""),tree:1,init:1},notify:{type:"open",cnt:1,hideCnt:!0}})}).done(function(odata,pdata){var diff=self.diff(odata.files.concat(pdata&&pdata.tree?pdata.tree:[]));return diff.removed.length&&self.remove(diff),diff.added.length&&self.add(diff),diff.changed.length&&self.change(diff),dfrd.resolve(diff)}),dfrd},this.upload=function(files){return this.transport.upload(files,this)},this.bind=function(event,callback){var i;if(typeof callback=="function"){event=(""+event).toLowerCase().split(/\s+/);for(i=0;i<event.length;i++)listeners[event[i]]===void 0&&(listeners[event[i]]=[]),listeners[event[i]].push(callback)}return this},this.unbind=function(event,callback){var l=listeners[(""+event).toLowerCase()]||[],i=l.indexOf(callback);return i>-1&&l.splice(i,1),callback=null,this},this.trigger=function(event,data){var event=event.toLowerCase(),handlers=listeners[event]||[],i,j;this.debug("event-"+event,data);if(handlers.length){event=$.Event(event);for(i=0;i<handlers.length;i++){event.data=$.extend(!0,{},data);try{if(handlers[i](event,this)===!1||event.isDefaultPrevented()){this.debug("event-stoped",event.type);break}}catch(ex){window.console&&window.console.log&&window.console.log(ex)}}}return this},this.shortcut=function(s){var patterns,pattern,code,i,parts;if(this.options.allowShortcuts&&s.pattern&&$.isFunction(s.callback)){patterns=s.pattern.toUpperCase().split(/\s+/);for(i=0;i<patterns.length;i++)pattern=patterns[i],parts=pattern.split("+"),code=(code=parts.pop()).length==1?code>0?code:code.charCodeAt(0):$.ui.keyCode[code],code&&!shortcuts[pattern]&&(shortcuts[pattern]={keyCode:code,altKey:$.inArray("ALT",parts)!=-1,ctrlKey:$.inArray("CTRL",parts)!=-1,shiftKey:$.inArray("SHIFT",parts)!=-1,type:s.type||"keydown",callback:s.callback,description:s.description,pattern:pattern})}return this},this.shortcuts=function(){var ret=[];return $.each(shortcuts,function(i,s){ret.push([s.pattern,self.i18n(s.description)])}),ret},this.clipboard=function(hashes,cut){var map=function(){return $.map(clipboard,function(f){return f.hash})};return hashes!==void 0&&(clipboard.length&&this.trigger("unlockfiles",{files:map()}),remember=[],clipboard=$.map(hashes||[],function(hash){var file=files[hash];return file?(remember.push(hash),{hash:hash,phash:file.phash,name:file.name,mime:file.mime,read:file.read,locked:file.locked,cut:!!cut}):null}),this.trigger("changeclipboard",{clipboard:clipboard.slice(0,clipboard.length)}),cut&&this.trigger("lockfiles",{files:map()})),clipboard.slice(0,clipboard.length)},this.isCommandEnabled=function(name){return this._commands[name]?$.inArray(name,cwdOptions.disabled)===-1:!1},this.exec=function(cmd,files,opts){return this._commands[cmd]&&this.isCommandEnabled(cmd)?this._commands[cmd].exec(files,opts):$.Deferred().reject("No such command")},this.dialog=function(content,options){return $("<div/>").append(content).appendTo(node).elfinderdialog(options)},this.getUI=function(ui){return this.ui[ui]||node},this.command=function(name){return name===void 0?this._commands:this._commands[name]},this.resize=function(w,h){node.css("width",w).height(h).trigger("resize"),this.trigger("resize",{width:node.width(),height:node.height()})},this.restoreSize=function(){this.resize(width,height)},this.show=function(){node.show(),this.enable().trigger("show")},this.hide=function(){this.disable().trigger("hide"),node.hide()},this.destroy=function(){node&&node[0].elfinder&&(this.trigger("destroy").disable(),listeners={},shortcuts={},$(document).add(node).unbind("."+this.namespace),self.trigger=function(){},node.children().remove(),node.append(prevContent.contents()).removeClass(this.cssClass).attr("style",prevStyle),node[0].elfinder=null,syncInterval&&clearInterval(syncInterval))},this.setSort(this.storage("sort")||this.options.sort,this.storage("sortDirect")||this.options.sortDirect);if(!($.fn.selectable&&$.fn.draggable&&$.fn.droppable))return alert(this.i18n("errJqui"));if(!node.length)return alert(this.i18n("errNode"));if(!this.options.url)return alert(this.i18n("errURL"));$.extend($.ui.keyCode,{F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120}),this.dragUpload=!1,this.xhrUpload=typeof XMLHttpRequestUpload!="undefined"&&typeof File!="undefined"&&typeof FormData!="undefined",this.transport={},typeof this.options.transport=="object"&&(this.transport=this.options.transport,typeof this.transport.init=="function"&&this.transport.init(this)),typeof this.transport.send!="function"&&(this.transport.send=function(opts){return $.ajax(opts)}),this.transport.upload=="iframe"?this.transport.upload=$.proxy(this.uploads.iframe,this):typeof this.transport.upload=="function"?this.dragUpload=!!this.options.dragUploadAllow:this.xhrUpload?(this.transport.upload=$.proxy(this.uploads.xhr,this),this.dragUpload=!0):this.transport.upload=$.proxy(this.uploads.iframe,this),this.error=function(){var arg=arguments[0];return arguments.length==1&&typeof arg=="function"?self.bind("error",arg):self.trigger("error",{error:arg})},$.each(["enable","disable","load","open","reload","select","add"
,"remove","change","dblclick","getfile","lockfiles","unlockfiles","dragstart","dragstop","search","searchend","viewchange"],function(i,name){self[name]=function(){var arg=arguments[0];return arguments.length==1&&typeof arg=="function"?self.bind(name,arg):self.trigger(name,$.isPlainObject(arg)?arg:{})}}),this.enable(function(){!enabled&&self.visible()&&self.ui.overlay.is(":hidden")&&(enabled=!0,$("texarea:focus,input:focus,button").blur(),node.removeClass("elfinder-disabled"))}).disable(function(){prevEnabled=enabled,enabled=!1,node.addClass("elfinder-disabled")}).open(function(){selected=[]}).select(function(e){selected=$.map(e.data.selected||e.data.value||[],function(hash){return files[hash]?hash:null})}).error(function(e){var opts={cssClass:"elfinder-dialog-error",title:self.i18n(self.i18n("error")),resizable:!1,destroyOnClose:!0,buttons:{}};opts.buttons[self.i18n(self.i18n("btnClose"))]=function(){$(this).elfinderdialog("close")},self.dialog('<span class="elfinder-dialog-icon elfinder-dialog-icon-error"/>'+self.i18n(e.data.error),opts)}).bind("tree parents",function(e){cache(e.data.tree||[])}).bind("tmb",function(e){$.each(e.data.images||[],function(hash,tmb){files[hash]&&(files[hash].tmb=tmb)})}).add(function(e){cache(e.data.added||[])}).change(function(e){$.each(e.data.changed||[],function(i,file){var hash=file.hash;files[hash]=files[hash]?$.extend(files[hash],file):file})}).remove(function(e){var removed=e.data.removed||[],l=removed.length,rm=function(hash){var file=files[hash];file&&(file.mime=="directory"&&file.dirs&&$.each(files,function(h,f){f.phash==hash&&rm(h)}),delete files[hash])};while(l--)rm(removed[l])}).bind("search",function(e){cache(e.data.files)}).bind("rm",function(e){var play=beeper.canPlayType&&beeper.canPlayType('audio/wav; codecs="1"');play&&play!=""&&play!="no"&&$(beeper).html('<source src="./sounds/rm.wav" type="audio/wav">')[0].play()}),$.each(this.options.handlers,function(event,callback){self.bind(event,callback)}),this.history=new this.history(this),typeof this.options.getFileCallback=="function"&&this.commands.getfile&&(this.bind("dblclick",function(e){e.preventDefault(),self.exec("getfile").fail(function(){self.exec("open")})}),this.shortcut({pattern:"enter",description:this.i18n("cmdgetfile"),callback:function(){self.exec("getfile").fail(function(){self.exec(self.OS=="mac"?"rename":"open")})}}).shortcut({pattern:"ctrl+enter",description:this.i18n(this.OS=="mac"?"cmdrename":"cmdopen"),callback:function(){self.exec(self.OS=="mac"?"rename":"open")}})),this._commands={},$.isArray(this.options.commands)||(this.options.commands=[]),$.each(["open","reload","back","forward","up","home","info","quicklook","getfile","help"],function(i,cmd){$.inArray(cmd,self.options.commands)===-1&&self.options.commands.push(cmd)}),$.each(this.options.commands,function(i,name){var cmd=self.commands[name];$.isFunction(cmd)&&!self._commands[name]&&(cmd.prototype=base,self._commands[name]=new cmd,self._commands[name].setup(name,self.options.commandsOptions[name]||{}))}),node.addClass(this.cssClass).bind(mousedown,function(){!enabled&&self.enable()}),this.ui={workzone:$("<div/>").appendTo(node).elfinderworkzone(this),navbar:$("<div/>").appendTo(node).elfindernavbar(this,this.options.uiOptions.navbar||{}),contextmenu:$("<div/>").appendTo(node).elfindercontextmenu(this),overlay:$("<div/>").appendTo(node).elfinderoverlay({show:function(){self.disable()},hide:function(){prevEnabled&&self.enable()}}),cwd:$("<div/>").appendTo(node).elfindercwd(this,this.options.uiOptions.cwd||{}),notify:this.dialog("",{cssClass:"elfinder-dialog-notify",position:{top:"12px",right:"12px"},resizable:!1,autoOpen:!1,title:"&nbsp;",width:280}),statusbar:$('<div class="ui-widget-header ui-helper-clearfix ui-corner-bottom elfinder-statusbar"/>').hide().appendTo(node)},$.each(this.options.ui||[],function(i,ui){var name="elfinder"+ui,opts=self.options.uiOptions[ui]||{};!self.ui[ui]&&$.fn[name]&&(self.ui[ui]=$("<"+(opts.tag||"div")+"/>").appendTo(node)[name](self,opts))}),node[0].elfinder=this,this.options.resizable&&$.fn.resizable&&node.resizable({handles:"se",minWidth:300,minHeight:200}),this.options.width&&(width=this.options.width),this.options.height&&(height=parseInt(this.options.height)),self.resize(width,height),$(document).bind("click."+this.namespace,function(e){enabled&&!$(e.target).closest(node).length&&self.disable()}).bind(keydown+" "+keypress,execShortcut),this.trigger("init").request({data:{cmd:"open",target:self.lastDir(),init:1,tree:this.ui.tree?1:0},preventDone:!0,notify:{type:"open",cnt:1,hideCnt:!0},freeze:!0}).fail(function(){self.trigger("fail").disable().lastDir(""),listeners={},shortcuts={},$(document).add(node).unbind("."+this.namespace),self.trigger=function(){}}).done(function(data){self.load().debug("api",self.api),data=$.extend(!0,{},data),open(data),self.trigger("open",data)}),this.one("load",function(){node.trigger("resize"),self.options.sync>1e3&&(syncInterval=setInterval(function(){self.sync()},self.options.sync))})},elFinder.prototype={res:function(type,id){return this.resources[type]&&this.resources[type][id]},i18:{en:{translator:"",language:"English",direction:"ltr",dateFormat:"d.m.Y H:i",fancyDateFormat:"$1 H:i",messages:{}},months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},kinds:{unknown:"Unknown",directory:"Folder",symlink:"Alias","symlink-broken":"AliasBroken","application/x-empty":"TextPlain","application/postscript":"Postscript","application/vnd.ms-office":"MsOffice","application/vnd.ms-word":"MsWord","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"MsWord","application/vnd.ms-word.document.macroEnabled.12":"MsWord","application/vnd.openxmlformats-officedocument.wordprocessingml.template":"MsWord","application/vnd.ms-word.template.macroEnabled.12":"MsWord","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"MsWord","application/vnd.ms-excel":"MsExcel","application/vnd.ms-excel.sheet.macroEnabled.12":"MsExcel","application/vnd.openxmlformats-officedocument.spreadsheetml.template":"MsExcel","application/vnd.ms-excel.template.macroEnabled.12":"MsExcel","application/vnd.ms-excel.sheet.binary.macroEnabled.12":"MsExcel","application/vnd.ms-excel.addin.macroEnabled.12":"MsExcel","application/vnd.ms-powerpoint":"MsPP","application/vnd.openxmlformats-officedocument.presentationml.presentation":"MsPP","application/vnd.ms-powerpoint.presentation.macroEnabled.12":"MsPP","application/vnd.openxmlformats-officedocument.presentationml.slideshow":"MsPP","application/vnd.ms-powerpoint.slideshow.macroEnabled.12":"MsPP","application/vnd.openxmlformats-officedocument.presentationml.template":"MsPP","application/vnd.ms-powerpoint.template.macroEnabled.12":"MsPP","application/vnd.ms-powerpoint.addin.macroEnabled.12":"MsPP","application/vnd.openxmlformats-officedocument.presentationml.slide":"MsPP","application/vnd.ms-powerpoint.slide.macroEnabled.12":"MsPP","application/pdf":"PDF","application/xml":"XML","application/vnd.oasis.opendocument.text":"OO","application/vnd.oasis.opendocument.text-template":"OO","application/vnd.oasis.opendocument.text-web":"OO","application/vnd.oasis.opendocument.text-master":"OO","application/vnd.oasis.opendocument.graphics":"OO","application/vnd.oasis.opendocument.graphics-template":"OO","application/vnd.oasis.opendocument.presentation":"OO","application/vnd.oasis.opendocument.presentation-template":"OO","application/vnd.oasis.opendocument.spreadsheet":"OO","application/vnd.oasis.opendocument.spreadsheet-template":"OO","application/vnd.oasis.opendocument.chart":"OO","application/vnd.oasis.opendocument.formula":"OO","application/vnd.oasis.opendocument.database":"OO","application/vnd.oasis.opendocument.image":"OO","application/vnd.openofficeorg.extension":"OO","application/x-shockwave-flash":"AppFlash","application/flash-video":"Flash video","application/x-bittorrent":"Torrent","application/javascript"
:"JS","application/rtf":"RTF","application/rtfd":"RTF","application/x-font-ttf":"TTF","application/x-font-otf":"OTF","application/x-rpm":"RPM","application/x-web-config":"TextPlain","application/xhtml+xml":"HTML","application/docbook+xml":"DOCBOOK","application/x-awk":"AWK","application/x-gzip":"GZIP","application/x-bzip2":"BZIP","application/zip":"ZIP","application/x-zip":"ZIP","application/x-rar":"RAR","application/x-tar":"TAR","application/x-7z-compressed":"7z","application/x-jar":"JAR","text/plain":"TextPlain","text/x-php":"PHP","text/html":"HTML","text/javascript":"JS","text/css":"CSS","text/rtf":"RTF","text/rtfd":"RTF","text/x-c":"C","text/x-csrc":"C","text/x-chdr":"CHeader","text/x-c++":"CPP","text/x-c++src":"CPP","text/x-c++hdr":"CPPHeader","text/x-shellscript":"Shell","application/x-csh":"Shell","text/x-python":"Python","text/x-java":"Java","text/x-java-source":"Java","text/x-ruby":"Ruby","text/x-perl":"Perl","text/x-sql":"SQL","text/xml":"XML","text/x-comma-separated-values":"CSV","image/x-ms-bmp":"BMP","image/jpeg":"JPEG","image/gif":"GIF","image/png":"PNG","image/tiff":"TIFF","image/x-targa":"TGA","image/vnd.adobe.photoshop":"PSD","image/xbm":"XBITMAP","image/pxm":"PXM","audio/mpeg":"AudioMPEG","audio/midi":"AudioMIDI","audio/ogg":"AudioOGG","audio/mp4":"AudioMPEG4","audio/x-m4a":"AudioMPEG4","audio/wav":"AudioWAV","audio/x-mp3-playlist":"AudioPlaylist","video/x-dv":"VideoDV","video/mp4":"VideoMPEG4","video/mpeg":"VideoMPEG","video/x-msvideo":"VideoAVI","video/quicktime":"VideoMOV","video/x-ms-wmv":"VideoWM","video/x-flv":"VideoFlash","video/x-matroska":"VideoMKV","video/ogg":"VideoOGG"},rules:{defaults:function(data){return!data||data.added&&!$.isArray(data.added)||data.removed&&!$.isArray(data.removed)||data.changed&&!$.isArray(data.changed)?!1:!0},open:function(data){return data&&data.cwd&&data.files&&$.isPlainObject(data.cwd)&&$.isArray(data.files)},tree:function(data){return data&&data.tree&&$.isArray(data.tree)},parents:function(data){return data&&data.tree&&$.isArray(data.tree)},tmb:function(data){return data&&data.images&&($.isPlainObject(data.images)||$.isArray(data.images))},upload:function(data){return data&&($.isPlainObject(data.added)||$.isArray(data.added))},search:function(data){return data&&data.files&&$.isArray(data.files)}},sorts:{nameDirsFirst:1,kindDirsFirst:2,sizeDirsFirst:3,dateDirsFirst:4,name:5,kind:6,size:7,date:8},setSort:function(type,dir){type=this.sorts[type]?type:1,this.sort=this.sorts[type]||1,this.sortDirect=dir=="asc"||dir=="desc"?dir:"asc",this.storage("sort",type),this.storage("sortDirect",this.sortDirect),this.trigger("sortchange")},commands:{},parseUploadData:function(text){var data;if(!$.trim(text))return{error:["errResponse","errDataEmpty"]};try{data=$.parseJSON(text)}catch(e){return{error:["errResponse","errDataNotJSON"]}}return this.validResponse("upload",data)?(data=this.normalize(data),data.removed=$.map(data.added||[],function(f){return f.hash}),data):{error:["errResponse"]}},iframeCnt:0,uploads:{iframe:function(data,fm){var self=fm?fm:this,input=data.input,dfrd=$.Deferred().fail(function(error){error&&self.error(error)}).done(function(data){data.warning&&self.error(data.warning),data.removed&&self.remove(data),data.added&&self.add(data),data.changed&&self.change(data),self.trigger("upload",data),data.sync&&self.sync()}),name="iframe-"+self.namespace+ ++self.iframeCnt,form=$('<form action="'+self.uploadURL+'" method="post" enctype="multipart/form-data" encoding="multipart/form-data" target="'+name+'" style="display:none"><input type="hidden" name="cmd" value="upload" /></form>'),msie=$.browser.msie,onload=function(){abortto&&clearTimeout(abortto),notifyto&&clearTimeout(notifyto),notify&&self.notify({type:"upload",cnt:-cnt}),setTimeout(function(){msie&&$('<iframe src="javascript:false;"/>').appendTo(form),form.remove(),iframe.remove()},100)},iframe=$('<iframe src="'+(msie?"javascript:false;":"about:blank")+'" name="'+name+'" style="position:absolute;left:-1000px;top:-1000px" />').bind("load",function(){iframe.unbind("load").bind("load",function(){var data=self.parseUploadData(iframe.contents().text());onload(),data.error?dfrd.reject(data.error):dfrd.resolve(data)}),notifyto=setTimeout(function(){notify=!0,self.notify({type:"upload",cnt:cnt})},self.options.notifyDelay),self.options.iframeTimeout>0&&(abortto=setTimeout(function(){onload(),dfrd.reject([errors.connect,errors.timeout])},self.options.iframeTimeout)),form.submit()}),cnt,notify,notifyto,abortto;return input&&$(input).is(":file")&&$(input).val()?(form.append(input),cnt=input.files?input.files.length:1,form.append('<input type="hidden" name="'+(self.newAPI?"target":"current")+'" value="'+self.cwd().hash+'"/>').append('<input type="hidden" name="html" value="1"/>').append($(input).attr("name","upload[]")),$.each(self.options.onlyMimes||[],function(i,mime){form.append('<input type="hidden" name="mimes[]" value="'+mime+'"/>')}),$.each(self.options.customData,function(key,val){form.append('<input type="hidden" name="'+key+'" value="'+val+'"/>')}),form.appendTo("body"),iframe.appendTo("body"),dfrd):dfrd.reject()},xhr:function(data,fm){var self=fm?fm:this,dfrd=$.Deferred().fail(function(error){error&&self.error(error)}).done(function(data){data.warning&&self.error(data.warning),data.removed&&self.remove(data),data.added&&self.add(data),data.changed&&self.change(data),self.trigger("upload",data),data.sync&&self.sync()}).always(function(){notifyto&&clearTimeout(notifyto),notify&&self.notify({type:"upload",cnt:-cnt,progress:100*cnt})}),xhr=new XMLHttpRequest,formData=new FormData,files=data.input?data.input.files:data.files,cnt=files.length,loaded=5,notify=!1,startNotify=function(){return setTimeout(function(){notify=!0,self.notify({type:"upload",cnt:cnt,progress:loaded*cnt})},self.options.notifyDelay)},notifyto;if(!cnt)return dfrd.reject();xhr.addEventListener("error",function(){dfrd.reject("errConnect")},!1),xhr.addEventListener("abort",function(){dfrd.reject(["errConnect","errAbort"])},!1),xhr.addEventListener("load",function(){var status=xhr.status,data;if(status>500)return dfrd.reject("errResponse");if(status!=200)return dfrd.reject("errConnect");if(xhr.readyState!=4)return dfrd.reject(["errConnect","errTimeout"]);if(!xhr.responseText)return dfrd.reject(["errResponse","errDataEmpty"]);data=self.parseUploadData(xhr.responseText),data.error?dfrd.reject(data.error):dfrd.resolve(data)},!1),xhr.upload.addEventListener("progress",function(e){var prev=loaded,curr;e.lengthComputable&&(curr=parseInt(e.loaded*100/e.total),curr>0&&!notifyto&&(notifyto=startNotify()),curr-prev>4&&(loaded=curr,notify&&self.notify({type:"upload",cnt:0,progress:(loaded-prev)*cnt})))},!1),xhr.open("POST",self.uploadURL,!0),formData.append("cmd","upload"),formData.append(self.newAPI?"target":"current",self.cwd().hash),$.each(self.options.customData,function(key,val){formData.append(key,val)}),$.each(self.options.onlyMimes,function(i,mime){formData.append("mimes["+i+"]",mime)}),$.each(files,function(i,file){formData.append("upload[]",file)}),xhr.onreadystatechange=function(){xhr.readyState==4&&xhr.status==0&&dfrd.reject(["errConnect","errAbort"])},xhr.send(formData);if(!$.browser.safari||!data.files)notifyto=startNotify();return dfrd}},one:function(event,callback){var self=this,h=$.proxy(callback,function(event){return setTimeout(function(){self.unbind(event.type,h)},3),callback.apply(this,arguments)});return this.bind(event,h)},localStorage:function(key,val){var s=window.localStorage;return key="elfinder-"+key+this.id,val!==void 0&&s.setItem(key,val),s.getItem(key)||""},cookie:function(name,value){var d,o,c,i;name="elfinder-"+name+this.id;if(value===void 0){if(document.cookie&&document.cookie!=""){c=document.cookie.split(";"),name+="=";for(i=0;i<c.length;i++){c[i]=$.trim(c[i]);if(c[i].substring(0,name.length)==name)return decodeURIComponent(c[i].substring(name.length))}}return""}return o=$.extend({},this.options.cookie),value===null&&(value="",o.expires=-1),typeof o.expires=="number"&&(d=new Date,d.setTime(d.getTime()+o.expires*864e5),o.expires=d),document.cookie=name+"="+encodeURIComponent(value)+"; expires="+o.expires.toUTCString()+(o.path?"; path="+o.path:"")+(
o.domain?"; domain="+o.domain:"")+(o.secure?"; secure":""),value},lastDir:function(hash){return this.options.rememberLastDir?this.storage("lastdir",hash):""},_node:$("<span/>"),escape:function(name){return this._node.text(name).html()},normalize:function(data){var filter=function(file){return file&&file.hash&&file.name&&file.mime?(file.mime=="application/x-empty"&&(file.mime="text/plain"),file):null};return data.files&&(data.files=$.map(data.files,filter)),data.tree&&(data.tree=$.map(data.tree,filter)),data.added&&(data.added=$.map(data.added,filter)),data.changed&&(data.changed=$.map(data.changed,filter)),data.api&&(data.init=!0),data},compare:function(file1,file2){var sort=this.sort,asc=this.sortDirect=="asc",f1=asc?file1:file2,f2=asc?file2:file1,m1=this.mime2kind(f1.mime).toLowerCase(),m2=this.mime2kind(f2.mime).toLowerCase(),d1=file1.mime=="directory",d2=file2.mime=="directory",n1=f1.name.toLowerCase(),n2=f2.name.toLowerCase(),s1=d1?0:parseInt(f1.size)||0,s2=d2?0:parseInt(f2.size)||0,t1=f1.ts||f1.date||"",t2=f2.ts||f2.date||"";if(sort<=4){if(d1&&!d2)return-1;if(!d1&&d2)return 1}return sort!=2&&sort!=6||m1==m2?sort!=3&&sort!=7||s1==s2?sort!=4&&sort!=8||t1==t2?f1.name.localeCompare(f2.name):t1>t2?1:-1:s1>s2?1:-1:m1.localeCompare(m2)},sortFiles:function(files){return files.sort($.proxy(this.compare,this))},notify:function(opts){var type=opts.type,msg=this.messages["ntf"+type]?this.i18n("ntf"+type):this.i18n("ntfsmth"),ndialog=this.ui.notify,notify=ndialog.children(".elfinder-notify-"+type),ntpl='<div class="elfinder-notify elfinder-notify-{type}"><span class="elfinder-dialog-icon elfinder-dialog-icon-{type}"/><span class="elfinder-notify-msg">{msg}</span> <span class="elfinder-notify-cnt"/><div class="elfinder-notify-progressbar"><div class="elfinder-notify-progress"/></div></div>',delta=opts.cnt,progress=opts.progress>=0&&opts.progress<=100?opts.progress:0,cnt,total,prc;return type?(notify.length||(notify=$(ntpl.replace(/\{type\}/g,type).replace(/\{msg\}/g,msg)).appendTo(ndialog).data("cnt",0),progress&&notify.data({progress:0,total:0})),cnt=delta+parseInt(notify.data("cnt")),cnt>0?(!opts.hideCnt&&notify.children(".elfinder-notify-cnt").text("("+cnt+")"),ndialog.is(":hidden")&&ndialog.elfinderdialog("open"),notify.data("cnt",cnt),progress<100&&(total=notify.data("total"))>=0&&(prc=notify.data("progress"))>=0&&(total=delta+parseInt(notify.data("total")),prc=progress+prc,progress=parseInt(prc/total),notify.data({progress:prc,total:total}),ndialog.find(".elfinder-notify-progress").animate({width:(progress<100?progress:100)+"%"},20))):(notify.remove(),!ndialog.children().length&&ndialog.elfinderdialog("close")),this):this},confirm:function(opts){var complete=!1,options={cssClass:"elfinder-dialog-confirm",modal:!0,resizable:!1,title:this.i18n(opts.title||"confirmReq"),buttons:{},close:function(){!complete&&opts.cancel.callback(),$(this).elfinderdialog("destroy")}},apply=this.i18n("apllyAll"),label,checkbox;return opts.reject&&(options.buttons[this.i18n(opts.reject.label)]=function(){opts.reject.callback(!!checkbox&&!!checkbox.prop("checked")),complete=!0,$(this).elfinderdialog("close")}),options.buttons[this.i18n(opts.accept.label)]=function(){opts.accept.callback(!!checkbox&&!!checkbox.prop("checked")),complete=!0,$(this).elfinderdialog("close")},options.buttons[this.i18n(opts.cancel.label)]=function(){$(this).elfinderdialog("close")},opts.all&&(opts.reject&&(options.width=370),options.create=function(){checkbox=$('<input type="checkbox" />'),$(this).next().children().before($("<label>"+apply+"</label>").prepend(checkbox))},options.open=function(){var pane=$(this).next(),width=parseInt(pane.children(":first").outerWidth()+pane.children(":last").outerWidth());width>parseInt(pane.width())&&$(this).closest(".elfinder-dialog").width(width+30)}),this.dialog('<span class="elfinder-dialog-icon elfinder-dialog-icon-confirm"/>'+this.i18n(opts.text),options)},uniqueName:function(prefix,phash){var i=0,ext="",p,name;prefix=this.i18n(prefix),phash=phash||this.cwd().hash,(p=prefix.indexOf(".txt"))!=-1&&(ext=".txt",prefix=prefix.substr(0,p)),name=prefix+ext;if(!this.fileByName(name,phash))return name;while(i<1e4){name=prefix+" "+ ++i+ext;if(!this.fileByName(name,phash))return name}return prefix+Math.random()+ext},i18n:function(){var self=this,messages=this.messages,input=[],ignore=[],message=function(m){var file;if(m.indexOf("#")===0)if(file=self.file(m.substr(1)))return file.name;return m},i,j,m;for(i=0;i<arguments.length;i++){m=arguments[i];if(typeof m=="string")input.push(message(m));else if($.isArray(m))for(j=0;j<m.length;j++)typeof m[j]=="string"&&input.push(message(m[j]))}for(i=0;i<input.length;i++){if($.inArray(i,ignore)!==-1)continue;m=input[i],m=messages[m]||m,m=m.replace(/\$(\d+)/g,function(match,placeholder){return placeholder=i+parseInt(placeholder),placeholder>0&&input[placeholder]&&ignore.push(placeholder),input[placeholder]||""}),input[i]=m}return $.map(input,function(m,i){return $.inArray(i,ignore)===-1?m:null}).join("<br>")},mime2class:function(mime){var prefix="elfinder-cwd-icon-";return mime=mime.split("/"),prefix+mime[0]+(mime[0]!="image"&&mime[1]?" "+prefix+mime[1].replace(/(\.|\+)/g,"-"):"")},mime2kind:function(f){var mime=typeof f=="object"?f.mime:f,kind;f.alias?kind="Alias":this.kinds[mime]?kind=this.kinds[mime]:mime.indexOf("text")===0?kind="Text":mime.indexOf("image")===0?kind="Image":mime.indexOf("audio")===0?kind="Audio":mime.indexOf("video")===0?kind="Video":mime.indexOf("application")===0?kind="App":kind=mime;return this.messages["kind"+kind]?this.i18n("kind"+kind):mime;var mime,kind},formatDate:function(file,ts){var self=this,ts=ts||file.ts,i18=self.i18,date,format,output,d,dw,m,y,h,g,i,s;return self.options.clientFormatDate&&ts>0?(date=new Date(ts*1e3),h=date[self.getHours](),g=h>12?h-12:h,i=date[self.getMinutes](),s=date[self.getSeconds](),d=date[self.getDate](),dw=date[self.getDay](),m=date[self.getMonth]()+1,y=date[self.getFullYear](),format=ts>=this.yesterday?this.fancyFormat:this.dateFormat,output=format.replace(/[a-z]/gi,function(val){switch(val){case"d":return d>9?d:"0"+d;case"j":return d;case"D":return self.i18n(i18.daysShort[dw]);case"l":return self.i18n(i18.days[dw]);case"m":return m>9?m:"0"+m;case"n":return m;case"M":return self.i18n(i18.monthsShort[m-1]);case"F":return self.i18n(i18.months[m-1]);case"Y":return y;case"y":return(""+y).substr(2);case"H":return h>9?h:"0"+h;case"G":return h;case"g":return g;case"h":return g>9?g:"0"+g;case"a":return h>12?"pm":"am";case"A":return h>12?"PM":"AM";case"i":return i>9?i:"0"+i;case"s":return s>9?s:"0"+s}return val}),ts>=this.yesterday?output.replace("$1",this.i18n(ts>=this.today?"Today":"Yesterday")):output):file.date?file.date.replace(/([a-z]+)\s/i,function(a1,a2){return self.i18n(a2)+" "}):self.i18n("dateUnknown")},perms2class:function(o){var c="";return!o.read&&!o.write?c="elfinder-na":o.read?o.write||(c="elfinder-ro"):c="elfinder-wo",c},formatPermissions:function(f){var p=[];return f.read&&p.push(this.i18n("read")),f.write&&p.push(this.i18n("write")),p.length?p.join(" "+this.i18n("and")+" "):this.i18n("noaccess")},formatSize:function(s){var n=1,u="b";return s=="unknown"?this.i18n("unknown"):(s>1073741824?(n=1073741824,u="GB"):s>1048576?(n=1048576,u="MB"):s>1024&&(n=1024,u="KB"),s/=n,(s>0?n>=1048576?s.toFixed(2):Math.round(s):0)+" "+u)},navHash2Id:function(hash){return"nav-"+hash},navId2Hash:function(id){return typeof id=="string"?id.substr(4):!1},log:function(m){return window.console&&window.console.log&&window.console.log(m),this},debug:function(type,m){var d=this.options.debug;return(d=="all"||d===!0||$.isArray(d)&&$.inArray(type,d)!=-1)&&window.console&&window.console.log&&window.console.log("elfinder debug: ["+type+"] ["+this.id+"]",m),this},time:function(l){window.console&&window.console.time&&window.console.time(l)},timeEnd:function(l){window.console&&window.console.timeEnd&&window.console.timeEnd(l)}},elFinder.prototype.version="2.0 rc1",$.fn.elfinder=function(o){return o=="instance"?this.getElFinder():this.each(function(){var cmd=typeof o=="string"?o:"";this.elfinder||new elFinder(this,typeof o=="object"?o:{});switch(cmd){case"close":case"hide":this.elfinder.hide
();break;case"open":case"show":this.elfinder.show();break;case"destroy":this.elfinder.destroy()}})},$.fn.getElFinder=function(){var instance;return this.each(function(){if(this.elfinder)return instance=this.elfinder,!1}),instance},elFinder.prototype._options={url:"",requestType:"get",transport:{},urlUpload:"",dragUploadAllow:"auto",iframeTimeout:0,customData:{},handlers:{},lang:"en",cssClass:"",commands:["open","reload","home","up","back","forward","getfile","quicklook","download","rm","duplicate","rename","mkdir","mkfile","upload","copy","cut","paste","edit","extract","archive","search","info","view","help","resize","sort","netmount"],commandsOptions:{getfile:{onlyURL:!1,multiple:!1,folders:!1,oncomplete:""},upload:{ui:"uploadbutton"},quicklook:{autoplay:!0,jplayer:"extensions/jplayer"},edit:{mimes:[],editors:[]},help:{view:["about","shortcuts","help"]}},getFileCallback:null,defaultView:"icons",ui:["toolbar","tree","path","stat"],uiOptions:{toolbar:[["back","forward"],["netmount"],["mkdir","mkfile","upload"],["open","download","getfile"],["info"],["quicklook"],["copy","cut","paste"],["rm"],["duplicate","rename","edit","resize"],["extract","archive"],["search"],["view","sort"],["help"]],tree:{openRootOnLoad:!0,syncTree:!0},navbar:{minWidth:150,maxWidth:500}},onlyMimes:[],sort:"nameDirsFirst",sortDirect:"asc",clientFormatDate:!0,UTCDate:!1,dateFormat:"",fancyDateFormat:"",width:"auto",height:400,resizable:!0,notifyDelay:500,allowShortcuts:!0,rememberLastDir:!0,showFiles:30,showThreshold:50,validName:!1,sync:0,loadTmbs:5,cookie:{expires:30,domain:"",path:"/",secure:!1},contextmenu:{navbar:["open","|","copy","cut","paste","duplicate","|","rm","|","info"],cwd:["reload","back","|","upload","mkdir","mkfile","paste","|","sort","|","info"],files:["getfile","|","open","quicklook","|","download","|","copy","cut","paste","duplicate","|","rm","|","edit","rename","resize","|","archive","extract","|","info"]},debug:["error","warning","event-destroy"]},elFinder.prototype.history=function(fm){var self=this,update=!0,history=[],current,reset=function(){history=[fm.cwd().hash],current=0,update=!0},go=function(fwd){return fwd&&self.canForward()||!fwd&&self.canBack()?(update=!1,fm.exec("open",history[fwd?++current:--current]).fail(reset)):$.Deferred().reject()};this.canBack=function(){return current>0},this.canForward=function(){return current<history.length-1},this.back=go,this.forward=function(){return go(!0)},fm.open(function(e){var l=history.length,cwd=fm.cwd().hash;update&&(current>=0&&l>current+1&&history.splice(current+1),history[history.length-1]!=cwd&&history.push(cwd),current=history.length-1),update=!0}).reload(reset)},elFinder.prototype.command=function(fm){this.fm=fm,this.name="",this.title="",this.state=-1,this.alwaysEnabled=!1,this._disabled=!1,this.disableOnSearch=!1,this.updateOnSelect=!0,this._handlers={enable:function(){this.update(void 0,this.value)},disable:function(){this.update(-1,this.value)},"open reload load":function(e){this._disabled=!this.alwaysEnabled&&!this.fm.isCommandEnabled(this.name),this.update(void 0,this.value),this.change()}},this.handlers={},this.shortcuts=[],this.options={ui:"button"},this.setup=function(name,opts){var self=this,fm=this.fm,i,s;this.name=name,this.title=fm.messages["cmd"+name]?fm.i18n("cmd"+name):name,this.options=$.extend({},this.options,opts),this.listeners=[],this.updateOnSelect&&(this._handlers.select=function(){this.update(void 0,this.value)}),$.each($.extend({},self._handlers,self.handlers),function(cmd,handler){fm.bind(cmd,$.proxy(handler,self))});for(i=0;i<this.shortcuts.length;i++)s=this.shortcuts[i],s.callback=$.proxy(s.callback||function(){this.exec()},this),!s.description&&(s.description=this.title),fm.shortcut(s);this.disableOnSearch&&fm.bind("search searchend",function(e){self._disabled=e.type=="search",self.update(void 0,self.value)}),this.init()},this.init=function(){},this.exec=function(files,opts){return $.Deferred().reject()},this.disabled=function(){return this.state<0},this.enabled=function(){return this.state>-1},this.active=function(){return this.state>0},this.getstate=function(){return-1},this.update=function(s,v){var state=this.state,value=this.value;this._disabled?this.state=-1:this.state=s!==void 0?s:this.getstate(),this.value=v,(state!=this.state||value!=this.value)&&this.change()},this.change=function(c){var cmd,i;if(typeof c=="function")this.listeners.push(c);else for(i=0;i<this.listeners.length;i++){cmd=this.listeners[i];try{cmd(this.state,this.value)}catch(e){this.fm.debug("error",e)}}return this},this.hashes=function(hashes){return hashes?$.map($.isArray(hashes)?hashes:[hashes],function(hash){return fm.file(hash)?hash:null}):fm.selected()},this.files=function(hashes){var fm=this.fm;return hashes?$.map($.isArray(hashes)?hashes:[hashes],function(hash){return fm.file(hash)||null}):fm.selectedFiles()}},elFinder.prototype.resources={"class":{hover:"ui-state-hover",active:"ui-state-active",disabled:"ui-state-disabled",draggable:"ui-draggable",droppable:"ui-droppable",adroppable:"elfinder-droppable-active",cwdfile:"elfinder-cwd-file",cwd:"elfinder-cwd",tree:"elfinder-tree",treeroot:"elfinder-navbar-root",navdir:"elfinder-navbar-dir",navdirwrap:"elfinder-navbar-dir-wrapper",navarrow:"elfinder-navbar-arrow",navsubtree:"elfinder-navbar-subtree",navcollapse:"elfinder-navbar-collapsed",navexpand:"elfinder-navbar-expanded",treedir:"elfinder-tree-dir",placedir:"elfinder-place-dir",searchbtn:"elfinder-button-search"},tpl:{perms:'<span class="elfinder-perms"/>',symlink:'<span class="elfinder-symlink"/>',navicon:'<span class="elfinder-nav-icon"/>',navspinner:'<span class="elfinder-navbar-spinner"/>',navdir:'<div class="elfinder-navbar-wrapper"><span id="{id}" class="ui-corner-all elfinder-navbar-dir {cssclass}"><span class="elfinder-navbar-arrow"/><span class="elfinder-navbar-icon"/>{symlink}{permissions}{name}</span><div class="elfinder-navbar-subtree"/></div>'},mimes:{text:["application/x-empty","application/javascript","application/xhtml+xml","audio/x-mp3-playlist","application/x-web-config","application/docbook+xml","application/x-php","application/x-perl","application/x-awk","application/x-config","application/x-csh","application/xml"]},mixin:{make:function(){var fm=this.fm,cmd=this.name,cwd=fm.getUI("cwd"),dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}).always(function(){input.remove(),node.remove(),fm.enable()}),id="tmp_"+parseInt(Math.random()*1e5),phash=fm.cwd().hash,date=new Date,file={hash:id,name:fm.uniqueName(this.prefix),mime:this.mime,read:!0,write:!0,date:"Today "+date.getHours()+":"+date.getMinutes()},node=cwd.trigger("create."+fm.namespace,file).find("#"+id),input=$('<input type="text"/>').keydown(function(e){e.stopImmediatePropagation(),e.keyCode==$.ui.keyCode.ESCAPE?dfrd.reject():e.keyCode==$.ui.keyCode.ENTER&&input.blur()}).mousedown(function(e){e.stopPropagation()}).blur(function(){var name=$.trim(input.val()),parent=input.parent();if(parent.length){if(!name)return dfrd.reject("errInvName");if(fm.fileByName(name,phash))return dfrd.reject(["errExists",name]);parent.html(fm.escape(name)),fm.lockfiles({files:[id]}),fm.request({data:{cmd:cmd,name:name,target:phash},notify:{type:cmd,cnt:1},preventFail:!0,syncOnFail:!0}).fail(function(error){dfrd.reject(error)}).done(function(data){dfrd.resolve(data)})}});return this.disabled()||!node.length?dfrd.reject():(fm.disable(),node.find(".elfinder-cwd-filename").empty("").append(input.val(file.name)),input.select().focus(),dfrd)}}},$.fn.dialogelfinder=function(opts){var position="elfinderPosition",destroy="elfinderDestroyOnClose";this.not(".elfinder").each(function(){var doc=$(document),toolbar=$('<div class="ui-widget-header dialogelfinder-drag ui-corner-top">'+(opts.title||"Files")+"</div>"),button=$('<a href="#" class="dialogelfinder-drag-close ui-corner-all"><span class="ui-icon ui-icon-closethick"/></a>').appendTo(toolbar).click(function(e){e.preventDefault(),node.dialogelfinder("close")}),node=$(this).addClass("dialogelfinder").css("position","absolute").hide().appendTo("body").draggable({handle:".dialogelfinder-drag",containment:"parent"}).elfinder(opts).prepend(toolbar),elfinder=node.elfinder("instance")
;node.width(parseInt(node.width())||840).data(destroy,!!opts.destroyOnClose).find(".elfinder-toolbar").removeClass("ui-corner-top"),opts.position&&node.data(position,opts.position),opts.autoOpen!==!1&&$(this).dialogelfinder("open")});if(opts=="open"){var node=$(this),pos=node.data(position)||{top:parseInt($(document).scrollTop()+($("body").height()<node.height()?2:($("body").height()-node.height())/2)),left:parseInt($(document).scrollLeft()+($("body").width()<node.width()?2:($("body").width()-node.width())/2))},zindex=100;node.is(":hidden")&&($("body").find(":visible").each(function(){var $this=$(this),z;this!==node[0]&&$this.css("position")=="absolute"&&(z=parseInt($this.zIndex()))>zindex&&(zindex=z+1)}),node.zIndex(zindex).css(pos).show().trigger("resize"),setTimeout(function(){node.trigger("resize").mousedown()},200))}else if(opts=="close"){var node=$(this);node.is(":visible")&&(node.data(destroy)?node.elfinder("destroy").remove():node.elfinder("close"))}else if(opts=="instance")return $(this).getElFinder();return this},elFinder&&elFinder.prototype&&typeof elFinder.prototype.i18=="object"&&(elFinder.prototype.i18.en={translator:"Troex Nevelin &lt;troex@fury.scancode.ru&gt;",language:"English",direction:"ltr",dateFormat:"M d, Y h:i A",fancyDateFormat:"$1 h:i A",messages:{error:"Error",errUnknown:"Unknown error.",errUnknownCmd:"Unknown command.",errJqui:"Invalid jQuery UI configuration. Selectable, draggable and droppable components must be included.",errNode:"elFinder requires DOM Element to be created.",errURL:"Invalid elFinder configuration! URL option is not set.",errAccess:"Access denied.",errConnect:"Unable to connect to backend.",errAbort:"Connection aborted.",errTimeout:"Connection timeout.",errNotFound:"Backend not found.",errResponse:"Invalid backend response.",errConf:"Invalid backend configuration.",errJSON:"PHP JSON module not installed.",errNoVolumes:"Readable volumes not available.",errCmdParams:'Invalid parameters for command "$1".',errDataNotJSON:"Data is not JSON.",errDataEmpty:"Data is empty.",errCmdReq:"Backend request requires command name.",errOpen:'Unable to open "$1".',errNotFolder:"Object is not a folder.",errNotFile:"Object is not a file.",errRead:'Unable to read "$1".',errWrite:'Unable to write into "$1".',errPerm:"Permission denied.",errLocked:'"$1" is locked and can not be renamed, moved or removed.',errExists:'File named "$1" already exists.',errInvName:"Invalid file name.",errFolderNotFound:"Folder not found.",errFileNotFound:"File not found.",errTrgFolderNotFound:'Target folder "$1" not found.',errPopup:"Browser prevented opening popup window. To open file enable it in browser options.",errMkdir:'Unable to create folder "$1".',errMkfile:'Unable to create file "$1".',errRename:'Unable to rename "$1".',errCopyFrom:'Copying files from volume "$1" not allowed.',errCopyTo:'Copying files to volume "$1" not allowed.',errUpload:"Upload error.",errUploadFile:'Unable to upload "$1".',errUploadNoFiles:"No files found for upload.",errUploadTotalSize:"Data exceeds the maximum allowed size.",errUploadFileSize:"File exceeds maximum allowed size.",errUploadMime:"File type not allowed.",errUploadTransfer:'"$1" transfer error.',errNotReplace:'Object "$1" already exists at this location and can not be replaced by object with another type.',errReplace:'Unable to replace "$1".',errSave:'Unable to save "$1".',errCopy:'Unable to copy "$1".',errMove:'Unable to move "$1".',errCopyInItself:'Unable to copy "$1" into itself.',errRm:'Unable to remove "$1".',errRmSrc:"Unable remove source file(s).",errExtract:'Unable to extract files from "$1".',errArchive:"Unable to create archive.",errArcType:"Unsupported archive type.",errNoArchive:"File is not archive or has unsupported archive type.",errCmdNoSupport:"Backend does not support this command.",errReplByChild:"The folder “$1” can’t be replaced by an item it contains.",errArcSymlinks:"For security reason denied to unpack archives contains symlinks.",errArcMaxSize:"Archive files exceeds maximum allowed size.",errResize:'Unable to resize "$1".',errUsupportType:"Unsupported file type.",errNotUTF8Content:'File "$1" is not in UTF-8 and cannot be edited.',errNetMount:'Unable to mount "$1".',errNetMountNoDriver:"Unsupported protocol.",errNetMountFailed:"Mount failed.",errNetMountHostReq:"Host required.",cmdarchive:"Create archive",cmdback:"Back",cmdcopy:"Copy",cmdcut:"Cut",cmddownload:"Download",cmdduplicate:"Duplicate",cmdedit:"Edit file",cmdextract:"Extract files from archive",cmdforward:"Forward",cmdgetfile:"Select files",cmdhelp:"About this software",cmdhome:"Home",cmdinfo:"Get info",cmdmkdir:"New folder",cmdmkfile:"New text file",cmdopen:"Open",cmdpaste:"Paste",cmdquicklook:"Preview",cmdreload:"Reload",cmdrename:"Rename",cmdrm:"Delete",cmdsearch:"Find files",cmdup:"Go to parent directory",cmdupload:"Upload files",cmdview:"View",cmdresize:"Resize & Rotate",cmdsort:"Sort",cmdnetmount:"Mount network volume",btnClose:"Close",btnSave:"Save",btnRm:"Remove",btnApply:"Apply",btnCancel:"Cancel",btnNo:"No",btnYes:"Yes",btnMount:"Mount",ntfopen:"Open folder",ntffile:"Open file",ntfreload:"Reload folder content",ntfmkdir:"Creating directory",ntfmkfile:"Creating files",ntfrm:"Delete files",ntfcopy:"Copy files",ntfmove:"Move files",ntfprepare:"Prepare to copy files",ntfrename:"Rename files",ntfupload:"Uploading files",ntfdownload:"Downloading files",ntfsave:"Save files",ntfarchive:"Creating archive",ntfextract:"Extracting files from archive",ntfsearch:"Searching files",ntfresize:"Resizing images",ntfsmth:"Doing something >_<",ntfloadimg:"Loading image",ntfnetmount:"Mounting network volume",dateUnknown:"unknown",Today:"Today",Yesterday:"Yesterday",Jan:"Jan",Feb:"Feb",Mar:"Mar",Apr:"Apr",May:"May",Jun:"Jun",Jul:"Jul",Aug:"Aug",Sep:"Sep",Oct:"Oct",Nov:"Nov",Dec:"Dec",sortnameDirsFirst:"by name (folders first)",sortkindDirsFirst:"by kind (folders first)",sortsizeDirsFirst:"by size (folders first)",sortdateDirsFirst:"by date (folders first)",sortname:"by name",sortkind:"by kind",sortsize:"by size",sortdate:"by date",confirmReq:"Confirmation required",confirmRm:"Are you sure you want to remove files?<br/>This cannot be undone!",confirmRepl:"Replace old file with new one?",apllyAll:"Apply to all",name:"Name",size:"Size",perms:"Permissions",modify:"Modified",kind:"Kind",read:"read",write:"write",noaccess:"no access",and:"and",unknown:"unknown",selectall:"Select all files",selectfiles:"Select file(s)",selectffile:"Select first file",selectlfile:"Select last file",viewlist:"List view",viewicons:"Icons view",places:"Places",calc:"Calculate",path:"Path",aliasfor:"Alias for",locked:"Locked",dim:"Dimensions",files:"Files",folders:"Folders",items:"Items",yes:"yes",no:"no",link:"Link",searcresult:"Search results",selected:"selected items",about:"About",shortcuts:"Shortcuts",help:"Help",webfm:"Web file manager",ver:"Version",protocolver:"protocol version",homepage:"Project home",docs:"Documentation",github:"Fork us on Github",twitter:"Follow us on twitter",facebook:"Join us on facebook",team:"Team",chiefdev:"chief developer",developer:"developer",contributor:"contributor",maintainer:"maintainer",translator:"translator",icons:"Icons",dontforget:"and don't forget to take your towel",shortcutsof:"Shortcuts disabled",dropFiles:"Drop files here",or:"or",selectForUpload:"Select files to upload",moveFiles:"Move files",copyFiles:"Copy files",rmFromPlaces:"Remove from places",aspectRatio:"Aspect ratio",scale:"Scale",width:"Width",height:"Height",resize:"Resize",crop:"Crop",rotate:"Rotate","rotate-cw":"Rotate 90 degrees CW","rotate-ccw":"Rotate 90 degrees CCW",degree:"°",netMountDialogTitle:"Mount network volume",protocol:"Protocol",host:"Host",port:"Port",user:"User",pass:"Password",kindUnknown:"Unknown",kindFolder:"Folder",kindAlias:"Alias",kindAliasBroken:"Broken alias",kindApp:"Application",kindPostscript:"Postscript document",kindMsOffice:"Microsoft Office document",kindMsWord:"Microsoft Word document",kindMsExcel:"Microsoft Excel document",kindMsPP:"Microsoft Powerpoint presentation",kindOO:"Open Office document",kindAppFlash:"Flash application",kindPDF:"Portable Document Format (PDF)",kindTorrent:"Bittorrent file",kind7z
:"7z archive",kindTAR:"TAR archive",kindGZIP:"GZIP archive",kindBZIP:"BZIP archive",kindZIP:"ZIP archive",kindRAR:"RAR archive",kindJAR:"Java JAR file",kindTTF:"True Type font",kindOTF:"Open Type font",kindRPM:"RPM package",kindText:"Text document",kindTextPlain:"Plain text",kindPHP:"PHP source",kindCSS:"Cascading style sheet",kindHTML:"HTML document",kindJS:"Javascript source",kindRTF:"Rich Text Format",kindC:"C source",kindCHeader:"C header source",kindCPP:"C++ source",kindCPPHeader:"C++ header source",kindShell:"Unix shell script",kindPython:"Python source",kindJava:"Java source",kindRuby:"Ruby source",kindPerl:"Perl script",kindSQL:"SQL source",kindXML:"XML document",kindAWK:"AWK source",kindCSV:"Comma separated values",kindDOCBOOK:"Docbook XML document",kindImage:"Image",kindBMP:"BMP image",kindJPEG:"JPEG image",kindGIF:"GIF Image",kindPNG:"PNG Image",kindTIFF:"TIFF image",kindTGA:"TGA image",kindPSD:"Adobe Photoshop image",kindXBITMAP:"X bitmap image",kindPXM:"Pixelmator image",kindAudio:"Audio media",kindAudioMPEG:"MPEG audio",kindAudioMPEG4:"MPEG-4 audio",kindAudioMIDI:"MIDI audio",kindAudioOGG:"Ogg Vorbis audio",kindAudioWAV:"WAV audio",AudioPlaylist:"MP3 playlist",kindVideo:"Video media",kindVideoDV:"DV movie",kindVideoMPEG:"MPEG movie",kindVideoMPEG4:"MPEG-4 movie",kindVideoAVI:"AVI movie",kindVideoMOV:"Quick Time movie",kindVideoWM:"Windows Media movie",kindVideoFlash:"Flash movie",kindVideoMKV:"Matroska movie",kindVideoOGG:"Ogg movie"}}),$.fn.elfinderbutton=function(cmd){return this.each(function(){var c="class",fm=cmd.fm,disabled=fm.res(c,"disabled"),active=fm.res(c,"active"),hover=fm.res(c,"hover"),item="elfinder-button-menu-item",selected="elfinder-button-menu-item-selected",menu,button=$(this).addClass("ui-state-default elfinder-button").attr("title",cmd.title).append('<span class="elfinder-button-icon elfinder-button-icon-'+cmd.name+'"/>').hover(function(e){!button.is("."+disabled)&&button[e.type=="mouseleave"?"removeClass":"addClass"](hover)}).click(function(e){button.is("."+disabled)||(menu&&cmd.variants.length>1?(menu.is(":hidden")&&cmd.fm.getUI().click(),e.stopPropagation(),menu.slideToggle(100)):cmd.exec())}),hideMenu=function(){menu.hide()};$.isArray(cmd.variants)&&(button.addClass("elfinder-menubutton"),menu=$('<div class="ui-widget ui-widget-content elfinder-button-menu ui-corner-all"/>').hide().appendTo(button).zIndex(12+button.zIndex()).delegate("."+item,"hover",function(){$(this).toggleClass(hover)}).delegate("."+item,"click",function(e){e.preventDefault(),e.stopPropagation(),button.removeClass(hover),cmd.exec(cmd.fm.selected(),$(this).data("value"))}),cmd.fm.bind("disable select",hideMenu).getUI().click(hideMenu),cmd.change(function(){menu.html(""),$.each(cmd.variants,function(i,variant){menu.append($('<div class="'+item+'">'+variant[1]+"</div>").data("value",variant[0]).addClass(variant[0]==cmd.value?selected:""))})})),cmd.change(function(){cmd.disabled()?button.removeClass(active+" "+hover).addClass(disabled):(button.removeClass(disabled),button[cmd.active()?"addClass":"removeClass"](active))}).change()})},$.fn.elfindercontextmenu=function(fm){return this.each(function(){var menu=$(this).addClass("ui-helper-reset ui-widget ui-state-default ui-corner-all elfinder-contextmenu elfinder-contextmenu-"+fm.direction).hide().appendTo("body").delegate(".elfinder-contextmenu-item","hover",function(){$(this).toggleClass("ui-state-hover")}),subpos=fm.direction=="ltr"?"left":"right",types=$.extend({},fm.options.contextmenu),tpl='<div class="elfinder-contextmenu-item"><span class="elfinder-button-icon {icon} elfinder-contextmenu-icon"/><span>{label}</span></div>',item=function(label,icon,callback){return $(tpl.replace("{icon}",icon?"elfinder-button-icon-"+icon:"").replace("{label}",label)).click(function(e){e.stopPropagation(),e.stopPropagation(),callback()})},open=function(x,y){var win=$(window),width=menu.outerWidth(),height=menu.outerHeight(),wwidth=win.width(),wheight=win.height(),scrolltop=win.scrollTop(),scrollleft=win.scrollLeft(),css={top:(y+height<wheight?y:y-height>0?y-height:y)+scrolltop,left:(x+width<wwidth?x:x-width)+scrollleft,"z-index":100+fm.getUI("workzone").zIndex()};menu.css(css).show(),css={"z-index":css["z-index"]+10},css[subpos]=parseInt(menu.width()),menu.find(".elfinder-contextmenu-sub").css(css)},close=function(){menu.hide().empty()},create=function(type,targets){var sep=!1;$.each(types[type]||[],function(i,name){var cmd,node,submenu;if(name=="|"&&sep){menu.append('<div class="elfinder-contextmenu-separator"/>'),sep=!1;return}cmd=fm.command(name);if(cmd&&cmd.getstate(targets)!=-1){if(cmd.variants){if(!cmd.variants.length)return;node=item(cmd.title,cmd.name,function(){}),submenu=$('<div class="ui-corner-all elfinder-contextmenu-sub"/>').appendTo(node.append('<span class="elfinder-contextmenu-arrow"/>')),node.addClass("elfinder-contextmenu-group").hover(function(){submenu.toggle()}),$.each(cmd.variants,function(i,variant){submenu.append($('<div class="elfinder-contextmenu-item"><span>'+variant[1]+"</span></div>").click(function(e){e.stopPropagation(),close(),cmd.exec(targets,variant[0])}))})}else node=item(cmd.title,cmd.name,function(){close(),cmd.exec(targets)});menu.append(node),sep=!0}})},createFromRaw=function(raw){$.each(raw,function(i,data){var node;data.label&&typeof data.callback=="function"&&(node=item(data.label,data.icon,function(){close(),data.callback()}),menu.append(node))})};fm.one("load",function(){fm.bind("contextmenu",function(e){var data=e.data;close(),data.type&&data.targets?create(data.type,data.targets):data.raw&&createFromRaw(data.raw),menu.children().length&&open(data.x,data.y)}).one("destroy",function(){menu.remove()}).bind("disable select",close).getUI().click(close)})})},$.fn.elfindercwd=function(fm){return this.not(".elfinder-cwd").each(function(){var list=fm.viewType=="list",undef="undefined",evtSelect="select."+fm.namespace,evtUnselect="unselect."+fm.namespace,evtDisable="disable."+fm.namespace,evtEnable="enable."+fm.namespace,c="class",clFile=fm.res(c,"cwdfile"),fileSelector="."+clFile,clSelected="ui-selected",clDisabled=fm.res(c,"disabled"),clDraggable=fm.res(c,"draggable"),clDroppable=fm.res(c,"droppable"),clHover=fm.res(c,"hover"),clDropActive=fm.res(c,"adroppable"),clTmp=clFile+"-tmp",tmbNum=fm.options.loadTmbs>0?fm.options.loadTmbs:5,query="",lastSearch=[],templates={icon:'<div id="{hash}" class="'+clFile+' {permsclass} {dirclass} ui-corner-all"><div class="elfinder-cwd-file-wrapper ui-corner-all"><div class="elfinder-cwd-icon {mime} ui-corner-all" unselectable="on" {style}/>{marker}</div><div class="elfinder-cwd-filename" title="{name}">{name}</div></div>',row:'<tr id="{hash}" class="'+clFile+' {permsclass} {dirclass}"><td><div class="elfinder-cwd-file-wrapper"><span class="elfinder-cwd-icon {mime}"/>{marker}<span class="elfinder-cwd-filename">{name}</span></div></td><td>{perms}</td><td>{date}</td><td>{size}</td><td>{kind}</td></tr>'},permsTpl=fm.res("tpl","perms"),symlinkTpl=fm.res("tpl","symlink"),replacement={permsclass:function(f){return fm.perms2class(f)},perms:function(f){return fm.formatPermissions(f)},dirclass:function(f){return f.mime=="directory"?"directory":""},mime:function(f){return fm.mime2class(f.mime)},size:function(f){return fm.formatSize(f.size)},date:function(f){return fm.formatDate(f)},kind:function(f){return fm.mime2kind(f)},marker:function(f){return(f.alias||f.mime=="symlink-broken"?symlinkTpl:"")+(!f.read||!f.write?permsTpl:"")}},itemhtml=function(f){return f.name=fm.escape(f.name),templates[list?"row":"icon"].replace(/\{([a-z]+)\}/g,function(s,e){return replacement[e]?replacement[e](f):f[e]?f[e]:""})},selectLock=!1,select=function(keyCode,append){function sibling(n,direction){return n[direction+"All"]("[id]:not(."+clDisabled+"):first")}var code=$.ui.keyCode,prev=keyCode==code.LEFT||keyCode==code.UP,sel=cwd.find("[id]."+clSelected),selector=prev?"first":"last",s,n,sib,top,left;if(sel.length){s=sel.filter(prev?":first":":last"),sib=sibling(s,prev?"prev":"next");if(!sib.length)n=s;else if(list||keyCode==code.LEFT||keyCode==code.RIGHT)n=sib;else{top=s.position().top,left=s.position().left,n=s;if(prev){do n=n.prev("[id]");while(n.length&&!(n.
position().top<top&&n.position().left<=left));n.is("."+clDisabled)&&(n=sibling(n,"next"))}else{do n=n.next("[id]");while(n.length&&!(n.position().top>top&&n.position().left>=left));n.is("."+clDisabled)&&(n=sibling(n,"prev")),n.length||(sib=cwd.find("[id]:not(."+clDisabled+"):last"),sib.position().top>top&&(n=sib))}}}else n=cwd.find("[id]:not(."+clDisabled+"):"+(prev?"last":"first"));n&&n.length&&(append?n=s.add(s[prev?"prevUntil":"nextUntil"]("#"+n.attr("id"))).add(n):sel.trigger(evtUnselect),n.trigger(evtSelect),scrollToView(n.filter(prev?":first":":last")),trigger())},selectFile=function(hash){cwd.find("#"+hash).trigger(evtSelect)},unselectAll=function(){cwd.find("[id]."+clSelected).trigger(evtUnselect)},selected=function(){return $.map(cwd.find("[id]."+clSelected),function(n){return n=$(n),n.is("."+clDisabled)?null:$(n).attr("id")})},trigger=function(){fm.trigger("select",{selected:selected()})},scrollToView=function(o){var ftop=o.position().top,fheight=o.outerHeight(!0),wtop=wrapper.scrollTop(),wheight=wrapper.innerHeight();ftop+fheight>wtop+wheight?wrapper.scrollTop(parseInt(ftop+fheight-wheight)):ftop<wtop&&wrapper.scrollTop(ftop)},buffer=[],index=function(hash){var l=buffer.length;while(l--)if(buffer[l].hash==hash)return l;return-1},scrollEvent="scroll."+fm.namespace,render=function(){var html=[],dirs=!1,ltmb=[],atmb={},last=cwd.find("[id]:last"),top=!last.length,place=list?cwd.children("table").children("tbody"):cwd,files;if(!buffer.length)return wrapper.unbind(scrollEvent);while((!last.length||last.position().top<=wrapper.height()+wrapper.scrollTop()+fm.options.showThreshold)&&(files=buffer.splice(0,fm.options.showFiles)).length)html=$.map(files,function(f){return f.hash&&f.name?(f.mime=="directory"&&(dirs=!0),f.tmb&&(f.tmb===1?ltmb.push(f.hash):atmb[f.hash]=f.tmb),itemhtml(f)):null}),place.append(html.join("")),last=cwd.find("[id]:last"),top&&cwd.scrollTop(0);attachThumbnails(atmb),ltmb.length&&loadThumbnails(ltmb),dirs&&makeDroppable()},droppable=$.extend({},fm.droppable,{over:function(e,ui){var hash=fm.cwd().hash;$.each(ui.helper.data("files"),function(i,h){if(fm.file(h).phash==hash)return cwd.removeClass(clDropActive),!1})}}),makeDroppable=function(){setTimeout(function(){cwd.find(".directory:not(."+clDroppable+",.elfinder-na,.elfinder-ro)").droppable(fm.droppable)},20)},attachThumbnails=function(images){var url=fm.option("tmbUrl"),ret=!0,ndx;return $.each(images,function(hash,tmb){var node=cwd.find("#"+hash);node.length?function(node,tmb){$("<img/>").load(function(){node.find(".elfinder-cwd-icon").css("background","url('"+tmb+"') center center no-repeat")}).attr("src",tmb)}(node,url+tmb):(ret=!1,(ndx=index(hash))!=-1&&(buffer[ndx].tmb=tmb))}),ret},loadThumbnails=function(files){var tmbs=[];if(fm.oldAPI){fm.request({data:{cmd:"tmb",current:fm.cwd().hash},preventFail:!0}).done(function(data){attachThumbnails(data.images||[])&&data.tmb&&loadThumbnails()});return}tmbs=tmbs=files.splice(0,tmbNum),tmbs.length&&fm.request({data:{cmd:"tmb",targets:tmbs},preventFail:!0}).done(function(data){attachThumbnails(data.images||[])&&loadThumbnails(files)})},add=function(files){var place=list?cwd.find("tbody"):cwd,l=files.length,ltmb=[],atmb={},dirs=!1,findNode=function(file){var pointer=cwd.find("[id]:first"),file2;while(pointer.length){file2=fm.file(pointer.attr("id"));if(file2&&fm.compare(file,file2)<0)return pointer;pointer=pointer.next("[id]")}},findIndex=function(file){var l=buffer.length,i;for(i=0;i<l;i++)if(fm.compare(file,buffer[i])<0)return i;return l||-1},file,hash,node,ndx;while(l--){file=files[l],hash=file.hash;if(cwd.find("#"+hash).length)continue;(node=findNode(file))&&node.length?node.before(itemhtml(file)):(ndx=findIndex(file))>=0?buffer.splice(ndx,0,file):place.append(itemhtml(file)),cwd.find("#"+hash).length&&(file.mime=="directory"?dirs=!0:file.tmb&&(file.tmb===1?ltmb.push(hash):atmb[hash]=file.tmb))}attachThumbnails(atmb),ltmb.length&&loadThumbnails(ltmb),dirs&&makeDroppable()},remove=function(files){var l=files.length,hash,n,ndx;while(l--){hash=files[l];if((n=cwd.find("#"+hash)).length)try{n.detach()}catch(e){fm.debug("error",e)}else(ndx=index(hash))!=-1&&buffer.splice(ndx,1)}},msg={name:fm.i18n("name"),perm:fm.i18n("perms"),mod:fm.i18n("modify"),size:fm.i18n("size"),kind:fm.i18n("kind")},content=function(files,any){var phash=fm.cwd().hash;try{cwd.children("table,"+fileSelector).remove().end()}catch(e){cwd.html("")}cwd.removeClass("elfinder-cwd-view-icons elfinder-cwd-view-list").addClass("elfinder-cwd-view-"+(list?"list":"icons")),wrapper[list?"addClass":"removeClass"]("elfinder-cwd-wrapper-list"),list&&cwd.html('<table><thead><tr class="ui-state-default"><td >'+msg.name+"</td><td>"+msg.perm+"</td><td>"+msg.mod+"</td><td>"+msg.size+"</td><td>"+msg.kind+"</td></tr></thead><tbody/></table>"),buffer=$.map(files,function(f){return any||f.phash==phash?f:null}),buffer=fm.sortFiles(buffer),wrapper.bind(scrollEvent,render).trigger(scrollEvent),trigger()},cwd=$(this).addClass("ui-helper-clearfix elfinder-cwd").attr("unselectable","on").delegate(fileSelector,"click."+fm.namespace,function(e){var p=this.id?$(this):$(this).parents("[id]:first"),prev=p.prevAll("."+clSelected+":first"),next=p.nextAll("."+clSelected+":first"),pl=prev.length,nl=next.length,sib;e.stopImmediatePropagation(),e.shiftKey&&(pl||nl)?(sib=pl?p.prevUntil("#"+prev.attr("id")):p.nextUntil("#"+next.attr("id")),sib.add(p).trigger(evtSelect)):e.ctrlKey||e.metaKey?p.trigger(p.is("."+clSelected)?evtUnselect:evtSelect):(cwd.find("[id]."+clSelected).trigger(evtUnselect),p.trigger(evtSelect)),trigger()}).delegate(fileSelector,"dblclick."+fm.namespace,function(e){fm.dblclick({file:this.id})}).delegate(fileSelector,"mouseenter."+fm.namespace,function(e){var $this=$(this),target=list?$this:$this.children();!$this.is("."+clTmp)&&!target.is("."+clDraggable+",."+clDisabled)&&target.draggable(fm.draggable)}).delegate(fileSelector,evtSelect,function(e){var $this=$(this);!selectLock&&!$this.is("."+clDisabled)&&$this.addClass(clSelected).children().addClass(clHover)}).delegate(fileSelector,evtUnselect,function(e){!selectLock&&$(this).removeClass(clSelected).children().removeClass(clHover)}).delegate(fileSelector,evtDisable,function(){var $this=$(this).removeClass(clSelected).addClass(clDisabled),target=(list?$this:$this.children()).removeClass(clHover);$this.is("."+clDroppable)&&$this.droppable("disable"),target.is("."+clDraggable)&&target.draggable("disable"),!list&&target.removeClass(clDisabled)}).delegate(fileSelector,evtEnable,function(){var $this=$(this).removeClass(clDisabled),target=list?$this:$this.children();$this.is("."+clDroppable)&&$this.droppable("enable"),target.is("."+clDraggable)&&target.draggable("enable")}).delegate(fileSelector,"scrolltoview",function(){scrollToView($(this))}).delegate(fileSelector,"hover",function(e){fm.trigger("hover",{hash:$(this).attr("id"),type:e.type})}).bind("contextmenu."+fm.namespace,function(e){var file=$(e.target).closest("."+clFile);file.length&&(e.stopPropagation(),e.preventDefault(),file.is("."+clDisabled)||(file.is("."+clSelected)||(cwd.trigger("unselectall"),file.trigger(evtSelect),trigger()),fm.trigger("contextmenu",{type:"files",targets:fm.selected(),x:e.clientX,y:e.clientY})))}).selectable({filter:fileSelector,stop:trigger,selected:function(e,ui){$(ui.selected).trigger(evtSelect)},unselected:function(e,ui){$(ui.unselected).trigger(evtUnselect)}}).droppable(droppable).bind("create."+fm.namespace,function(e,file){var parent=list?cwd.find("tbody"):cwd;cwd.trigger("unselectall"),parent.prepend($(itemhtml(file)).addClass(clTmp)),cwd.scrollTop(0)}).bind("unselectall",function(){cwd.find("[id]."+clSelected+"").trigger(evtUnselect),trigger()}).bind("selectfile",function(e,id){cwd.find("#"+id).trigger(evtSelect),trigger()}),wrapper=$('<div class="elfinder-cwd-wrapper"/>').bind("contextmenu",function(e){e.preventDefault(),fm.trigger("contextmenu",{type:"cwd",targets:[fm.cwd().hash],x:e.clientX,y:e.clientY})}),resize=function(){var h=0;wrapper.siblings(".elfinder-panel:visible").each(function(){h+=$(this).outerHeight(!0)}),wrapper.height(wz.height()-h)},parent=$(this).parent().resize(resize),wz=parent.children(".elfinder-workzone").append
(wrapper.append(this));fm.dragUpload&&(wrapper[0].addEventListener("dragenter",function(e){e.preventDefault(),e.stopPropagation(),wrapper.addClass(clDropActive)},!1),wrapper[0].addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),e.target==cwd[0]&&wrapper.removeClass(clDropActive)},!1),wrapper[0].addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()},!1),wrapper[0].addEventListener("drop",function(e){e.preventDefault(),wrapper.removeClass(clDropActive),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length&&fm.exec("upload",{files:e.dataTransfer.files})},!1)),fm.bind("open",function(e){content(e.data.files)}).bind("search",function(e){lastSearch=e.data.files,content(lastSearch,!0)}).bind("searchend",function(){query&&content(fm.files()),lastSearch=[],query=""}).bind("searchstart",function(e){query=e.data.query}).bind("sortchange",function(){content(query?lastSearch:fm.files(),!!query)}).bind("viewchange",function(){var sel=fm.selected(),l=fm.storage("view")=="list";l!=list&&(list=l,content(fm.files()),$.each(sel,function(i,h){selectFile(h)}),trigger()),resize()}).add(function(e){var phash=fm.cwd().hash,files=query?$.map(e.data.added||[],function(f){return f.name.indexOf(query)===-1?null:f}):$.map(e.data.added||[],function(f){return f.phash==phash?f:null});add(files)}).change(function(e){var phash=fm.cwd().hash,sel=fm.selected(),files;query?$.each(e.data.changed||[],function(i,file){remove([file.hash]),file.name.indexOf(query)!==-1&&(add([file]),$.inArray(file.hash,sel)!==-1&&selectFile(file.hash))}):$.each($.map(e.data.changed||[],function(f){return f.phash==phash?f:null}),function(i,file){remove([file.hash]),add([file]),$.inArray(file.hash,sel)!==-1&&selectFile(file.hash)}),trigger()}).remove(function(e){remove(e.data.removed||[]),trigger()}).bind("open add search searchend",function(){cwd.css("height","auto"),cwd.outerHeight(!0)<wrapper.height()&&cwd.height(wrapper.height()-(cwd.outerHeight(!0)-cwd.height())-2)}).dragstart(function(e){var target=$(e.data.target),oe=e.data.originalEvent;target.is(fileSelector)&&(target.is("."+clSelected)||(!(oe.ctrlKey||oe.metaKey||oe.shiftKey)&&unselectAll(),target.trigger(evtSelect),trigger()),cwd.droppable("disable")),cwd.selectable("disable").removeClass(clDisabled),selectLock=!0}).dragstop(function(){cwd.selectable("enable"),selectLock=!1}).bind("lockfiles unlockfiles",function(e){var event=e.type=="lockfiles"?evtDisable:evtEnable,files=e.data.files||[],l=files.length;while(l--)cwd.find("#"+files[l]).trigger(event);trigger()}).bind("mkdir mkfile duplicate upload rename archive extract",function(e){var phash=fm.cwd().hash,files;cwd.trigger("unselectall"),$.each(e.data.added||[],function(i,file){file&&file.phash==phash&&selectFile(file.hash)}),trigger()}).shortcut({pattern:"ctrl+a",description:"selectall",callback:function(){var sel=[],phash;cwd.find("[id]:not(."+clSelected+")").trigger(evtSelect),buffer.length?(phash=fm.cwd().hash,fm.select({selected:$.map(fm.files(),function(f){return f.phash==phash?f.hash:null})})):trigger()}}).shortcut({pattern:"left right up down shift+left shift+right shift+up shift+down",description:"selectfiles",type:"keydown",callback:function(e){select(e.keyCode,e.shiftKey)}}).shortcut({pattern:"home",description:"selectffile",callback:function(e){unselectAll(),scrollToView(cwd.find("[id]:first").trigger(evtSelect)),trigger()}}).shortcut({pattern:"end",description:"selectlfile",callback:function(e){unselectAll(),scrollToView(cwd.find("[id]:last").trigger(evtSelect)),trigger()}})}),this},$.fn.elfinderdialog=function(opts){var dialog;return typeof opts=="string"&&(dialog=this.closest(".ui-dialog")).length&&(opts=="open"?dialog.css("display")=="none"&&dialog.fadeIn(120,function(){dialog.trigger("open")}):opts=="close"?dialog.css("display")!="none"&&dialog.hide().trigger("close"):opts=="destroy"?dialog.hide().remove():opts=="toTop"&&dialog.trigger("totop")),opts=$.extend({},$.fn.elfinderdialog.defaults,opts),this.filter(":not(.ui-dialog-content)").each(function(){var self=$(this).addClass("ui-dialog-content ui-widget-content"),parent=self.parent(),clactive="elfinder-dialog-active",cldialog="elfinder-dialog",clnotify="elfinder-dialog-notify",clhover="ui-state-hover",id=parseInt(Math.random()*1e6),overlay=parent.children(".elfinder-overlay"),buttonset=$('<div class="ui-dialog-buttonset"/>'),buttonpane=$('<div class=" ui-helper-clearfix ui-dialog-buttonpane ui-widget-content"/>').append(buttonset),dialog=$('<div class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-draggable std42-dialog  '+cldialog+" "+opts.cssClass+'"/>').hide().append(self).appendTo(parent).draggable({handle:".ui-dialog-titlebar",containment:$("body")}).css({width:opts.width,height:opts.height}).mousedown(function(e){e.stopPropagation(),$(document).mousedown(),dialog.is("."+clactive)||(parent.find("."+cldialog+":visible").removeClass(clactive),dialog.addClass(clactive).zIndex(maxZIndex()+1))}).bind("open",function(){opts.modal&&overlay.elfinderoverlay("show"),dialog.trigger("totop"),typeof opts.open=="function"&&$.proxy(opts.open,self[0])(),dialog.is("."+clnotify)||parent.find("."+cldialog+":visible").not("."+clnotify).each(function(){var d=$(this),top=parseInt(d.css("top")),left=parseInt(d.css("left")),_top=parseInt(dialog.css("top")),_left=parseInt(dialog.css("left"));d[0]!=dialog[0]&&(top==_top||left==_left)&&dialog.css({top:top+10+"px",left:left+10+"px"})})}).bind("close",function(){var dialogs=parent.find(".elfinder-dialog:visible"),z=maxZIndex();opts.modal&&overlay.elfinderoverlay("hide"),dialogs.length?dialogs.each(function(){var d=$(this);if(d.zIndex()>=z)return d.trigger("totop"),!1}):setTimeout(function(){parent.mousedown().click()},10),typeof opts.close=="function"?$.proxy(opts.close,self[0])():opts.destroyOnClose&&dialog.hide().remove()}).bind("totop",function(){$(this).mousedown().find(".ui-button:first").focus().end().find(":text:first").focus()}),maxZIndex=function(){var z=parent.zIndex()+10;return parent.find("."+cldialog+":visible").each(function(){var _z;this!=dialog[0]&&(_z=$(this).zIndex(),_z>z&&(z=_z))}),z},top;opts.position||(top=parseInt((parent.height()-dialog.outerHeight())/2-42),opts.position={top:(top>0?top:0)+"px",left:parseInt((parent.width()-dialog.outerWidth())/2)+"px"}),dialog.css(opts.position),opts.closeOnEscape&&$(document).bind("keyup."+id,function(e){e.keyCode==$.ui.keyCode.ESCAPE&&dialog.is("."+clactive)&&(self.elfinderdialog("close"),$(document).unbind("keyup."+id))}),dialog.prepend($('<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">'+opts.title+"</div>").prepend($('<a href="#" class="ui-dialog-titlebar-close ui-corner-all"><span class="ui-icon ui-icon-closethick"/></a>').mousedown(function(e){e.preventDefault(),self.elfinderdialog("close")}))),$.each(opts.buttons,function(name,cb){var button=$('<button type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"><span class="ui-button-text">'+name+"</span></button>").click($.proxy(cb,self[0])).hover(function(e){$(this)[e.type=="mouseenter"?"focus":"blur"]()}).focus(function(){$(this).addClass(clhover)}).blur(function(){$(this).removeClass(clhover)}).keydown(function(e){var next;e.keyCode==$.ui.keyCode.ENTER?$(this).click():e.keyCode==$.ui.keyCode.TAB&&(next=$(this).next(".ui-button"),next.length?next.focus():$(this).parent().children(".ui-button:first").focus())});buttonset.append(button)}),buttonset.children().length&&dialog.append(buttonpane),opts.resizable&&$.fn.resizable&&dialog.resizable({minWidth:opts.minWidth,minHeight:opts.minHeight,alsoResize:this}),typeof opts.create=="function"&&$.proxy(opts.create,this)(),opts.autoOpen&&self.elfinderdialog("open")}),this},$.fn.elfinderdialog.defaults={cssClass:"",title:"",modal:!1,resizable:!0,autoOpen:!0,closeOnEscape:!0,destroyOnClose:!1,buttons:{},position:null,width:320,height:"auto",minWidth:200,minHeight:110},$.fn.elfindernavbar=function(fm,opts){return this.not(".elfinder-navbar").each(function(){var nav=$(this).addClass("ui-state-default elfinder-navbar"),parent=nav.parent().resize(function(){nav.height(wz.height()-delta)}),wz=parent.
children(".elfinder-workzone").append(nav),delta=nav.outerHeight()-nav.height(),ltr=fm.direction=="ltr",handle;$.fn.resizable&&(handle=nav.resizable({handles:ltr?"e":"w",minWidth:opts.minWidth||150,maxWidth:opts.maxWidth||500}).bind("resize scroll",function(){handle.css({top:parseInt(nav.scrollTop())+"px",left:parseInt(ltr?nav.width()+nav.scrollLeft()-handle.width()-2:nav.scrollLeft()+2)})}).find(".ui-resizable-handle").zIndex(nav.zIndex()+10),ltr||nav.resize(function(){nav.css("left",null).css("right",0)}),fm.one("open",function(){setTimeout(function(){nav.trigger("resize")},150)}))}),this},$.fn.elfinderoverlay=function(opts){this.filter(":not(.elfinder-overlay)").each(function(){opts=$.extend({},opts),$(this).addClass("ui-widget-overlay elfinder-overlay").hide().mousedown(function(e){e.preventDefault(),e.stopPropagation()}).data({cnt:0,show:typeof opts.show=="function"?opts.show:function(){},hide:typeof opts.hide=="function"?opts.hide:function(){}})});if(opts=="show"){var o=this.eq(0),cnt=o.data("cnt")+1,show=o.data("show");o.data("cnt",cnt),o.is(":hidden")&&(o.zIndex(o.parent().zIndex()+1),o.show(),show())}if(opts=="hide"){var o=this.eq(0),cnt=o.data("cnt")-1,hide=o.data("hide");o.data("cnt",cnt),cnt==0&&o.is(":visible")&&(o.hide(),hide())}return this},$.fn.elfinderpanel=function(fm){return this.each(function(){var panel=$(this).addClass("elfinder-panel ui-state-default ui-corner-all"),margin="margin-"+(fm.direction=="ltr"?"left":"right");fm.one("load",function(e){var navbar=fm.getUI("navbar");panel.css(margin,parseInt(navbar.outerWidth(!0))),navbar.bind("resize",function(){panel.is(":visible")&&panel.css(margin,parseInt(navbar.outerWidth(!0)))})})})},$.fn.elfinderpath=function(fm){return this.each(function(){var path=$(this).addClass("elfinder-path").html("&nbsp;").delegate("a","click",function(e){var hash=$(this).attr("href").substr(1);e.preventDefault(),hash!=fm.cwd().hash&&fm.exec("open",hash)}).prependTo(fm.getUI("statusbar").show());fm.bind("open searchend",function(){var dirs=[];$.each(fm.parents(fm.cwd().hash),function(i,hash){dirs.push('<a href="#'+hash+'">'+fm.escape(fm.file(hash).name)+"</a>")}),path.html(dirs.join(fm.option("separator")))}).bind("search",function(){path.html(fm.i18n("searcresult"))})})},$.fn.elfinderplaces=function(fm,opts){return this.each(function(){var dirs=[],c="class",navdir=fm.res(c,"navdir"),collapsed=fm.res(c,"navcollapse"),expanded=fm.res(c,"navexpand"),hover=fm.res(c,"hover"),clroot=fm.res(c,"treeroot"),tpl=fm.res("tpl","navdir"),ptpl=fm.res("tpl","perms"),spinner=$(fm.res("tpl","navspinner")),id2hash=function(id){return id.substr(6)},hash2id=function(hash){return"place-"+hash},save=function(){fm.storage("places",dirs.join(","))},create=function(dir){return $(tpl.replace(/\{id\}/,hash2id(dir.hash)).replace(/\{name\}/,fm.escape(dir.name)).replace(/\{cssclass\}/,fm.perms2class(dir)).replace(/\{permissions\}/,!dir.read||!dir.write?ptpl:"").replace(/\{symlink\}/,""))},add=function(dir){var node=create(dir);subtree.children().length&&$.each(subtree.children(),function(){var current=$(this);if(dir.name.localeCompare(current.children("."+navdir).text())<0)return!node.insertBefore(current)}),dirs.push(dir.hash),!node.parent().length&&subtree.append(node),root.addClass(collapsed),node.draggable({appendTo:"body",revert:!1,helper:function(){var dir=$(this);return dir.children().removeClass("ui-state-hover"),$('<div class="elfinder-place-drag elfinder-'+fm.direction+'"/>').append(dir.clone()).data("hash",id2hash(dir.children(":first").attr("id")))},start:function(){$(this).hide()},stop:function(e,ui){var top=places.offset().top,left=places.offset().left,width=places.width(),height=places.height(),x=e.clientX,y=e.clientY;x>left&&x<left+width&&y>top&&y<y+height?$(this).show():(remove(ui.helper.data("hash")),save())}})},remove=function(hash){var ndx=$.inArray(hash,dirs);ndx!==-1&&(dirs.splice(ndx,1),subtree.find("#"+hash2id(hash)).parent().remove(),!subtree.children().length&&root.removeClass(collapsed+" "+expanded))},clear=function(){subtree.empty(),root.removeClass(collapsed+" "+expanded)},wrapper=create({hash:"root-"+fm.namespace,name:fm.i18n(opts.name,"places"),read:!0,write:!0}),root=wrapper.children("."+navdir).addClass(clroot).click(function(){root.is("."+collapsed)&&(places.toggleClass(expanded),subtree.slideToggle(),fm.storage("placesState",places.is("."+expanded)?1:0))}),subtree=wrapper.children("."+fm.res(c,"navsubtree")),places=$(this).addClass(fm.res(c,"tree")+" elfinder-places ui-corner-all").hide().append(wrapper).appendTo(fm.getUI("navbar")).delegate("."+navdir,"hover",function(){$(this).toggleClass("ui-state-hover")}).delegate("."+navdir,"click",function(e){fm.exec("open",$(this).attr("id").substr(6))}).delegate("."+navdir+":not(."+clroot+")","contextmenu",function(e){var hash=$(this).attr("id").substr(6);e.preventDefault(),fm.trigger("contextmenu",{raw:[{label:fm.i18n("rmFromPlaces"),icon:"rm",callback:function(){remove(hash),save()}}],x:e.clientX,y:e.clientY})}).droppable({tolerance:"pointer",accept:".elfinder-cwd-file-wrapper,.elfinder-tree-dir,.elfinder-cwd-file",hoverClass:fm.res("class","adroppable"),drop:function(e,ui){var resolve=!0;$.each(ui.helper.data("files"),function(i,hash){var dir=fm.file(hash);dir&&dir.mime=="directory"&&$.inArray(dir.hash,dirs)===-1?add(dir):resolve=!1}),save(),resolve&&ui.helper.hide()}});fm.one("load",function(){if(fm.oldAPI)return;places.show().parent().show(),dirs=$.map(fm.storage("places").split(","),function(hash){return hash||null}),dirs.length&&(root.prepend(spinner),fm.request({data:{cmd:"info",targets:dirs},preventDefault:!0}).done(function(data){dirs=[],$.each(data.files,function(i,file){file.mime=="directory"&&add(file)}),save(),fm.storage("placesState")>0&&root.click()}).always(function(){spinner.remove()})),fm.remove(function(e){$.each(e.data.removed,function(i,hash){remove(hash)}),save()}).change(function(e){$.each(e.data.changed,function(i,file){$.inArray(file.hash,dirs)!==-1&&(remove(file.hash),file.mime=="directory"&&add(file))}),save()}).bind("sync",function(){dirs.length&&(root.prepend(spinner),fm.request({data:{cmd:"info",targets:dirs},preventDefault:!0}).done(function(data){$.each(data.files||[],function(i,file){$.inArray(file.hash,dirs)===-1&&remove(file.hash)}),save()}).always(function(){spinner.remove()}))})})})},$.fn.elfindersearchbutton=function(cmd){return this.each(function(){var result=!1,button=$(this).hide().addClass("ui-widget-content elfinder-button "+cmd.fm.res("class","searchbtn")+""),search=function(){cmd.exec($.trim(input.val())).done(function(){result=!0,input.focus()})},abort=function(){input.val(""),result&&(result=!1,cmd.fm.trigger("searchend"))},input=$('<input type="text" size="42"/>').appendTo(button).keypress(function(e){e.stopPropagation()}).keydown(function(e){e.stopPropagation(),e.keyCode==13&&search(),e.keyCode==27&&(e.preventDefault(),abort())});$('<span class="ui-icon ui-icon-search" title="'+cmd.title+'"/>').appendTo(button).click(search),$('<span class="ui-icon ui-icon-close"/>').appendTo(button).click(abort),setTimeout(function(){button.parent().detach(),cmd.fm.getUI("toolbar").prepend(button.show());if($.browser.msie){var icon=button.children(cmd.fm.direction=="ltr"?".ui-icon-close":".ui-icon-search");icon.css({right:"",left:parseInt(button.width())-icon.outerWidth(!0)})}},200),cmd.fm.error(function(){input.unbind("keydown")}).select(function(){input.blur()}).bind("searchend",function(){input.val("")}).viewchange(abort).shortcut({pattern:"ctrl+f f3",description:cmd.title,callback:function(){input.select().focus()}})})},$.fn.elfindersortbutton=function(cmd){return this.each(function(){var c="class",fm=cmd.fm,disabled=fm.res(c,"disabled"),active=fm.res(c,"active"),hover=fm.res(c,"hover"),item="elfinder-button-menu-item",selected="elfinder-button-menu-item-selected",sort="elfinder-menu-item-sort-",menu,button=$(this).addClass("ui-state-default elfinder-button elfiner-button-"+cmd.name).attr("title",cmd.title).append('<span class="elfinder-button-icon elfinder-button-icon-'+cmd.name+'"/>').hover(function(e){!button.is("."+disabled)&&button.toggleClass(hover)}).click(function(e){!button.is("."+disabled)&&menu&&
cmd.variants.length>1&&(menu.is(":hidden")&&cmd.fm.getUI().click(),e.stopPropagation(),menu.slideToggle(100))}),hideMenu=function(){menu.hide()};$.isArray(cmd.variants)&&(button.addClass("elfinder-menubutton"),menu=$('<div class="ui-widget ui-widget-content elfinder-button-menu ui-corner-all"/>').hide().appendTo(button).zIndex(12+button.zIndex()).delegate("."+item,"hover",function(){$(this).toggleClass(hover)}).delegate("."+item,"click",function(e){e.preventDefault(),e.stopPropagation(),button.removeClass(hover),cmd.exec([],$(this).data("value"))}),cmd.fm.bind("disable select",hideMenu).getUI().click(hideMenu),$.each(cmd.variants,function(i,variant){menu.append($('<div class="'+item+" "+(variant[0]==cmd.value?selected:"")+" "+sort+fm.sortDirect+'"><span class="elfinder-menu-item-sort-dir"/>'+variant[1]+"</div>").data("value",variant[0]))})),cmd.change(function(){cmd.disabled()?button.removeClass(active+" "+hover).addClass(disabled):(button.removeClass(disabled),button[cmd.active()?"addClass":"removeClass"](active),menu.children("."+item).each(function(){var item=$(this).removeClass(sort+"asc "+sort+"desc");item.data("value")==cmd.value?item.addClass(selected+" "+sort+fm.sortDirect):item.removeClass(selected)}))}).change()})},$.fn.elfinderstat=function(fm){return this.each(function(){var size=$(this).addClass("elfinder-stat-size"),sel=$('<div class="elfinder-stat-selected"/>'),titlesize=fm.i18n("size").toLowerCase(),titleitems=fm.i18n("items").toLowerCase(),titlesel=fm.i18n("selected"),setstat=function(files,cwd){var c=0,s=0;$.each(files,function(i,file){if(!cwd||file.phash==cwd)c++,s+=parseInt(file.size)||0}),size.html(titleitems+": "+c+", "+titlesize+": "+fm.formatSize(s))};fm.getUI("statusbar").prepend(size).append(sel).show(),fm.bind("open reload add remove change searchend",function(){setstat(fm.files(),fm.cwd().hash)}).search(function(e){setstat(e.data.files)}).select(function(){var s=0,c=0,files=fm.selectedFiles();if(files.length==1){s=files[0].size,sel.html(fm.escape(files[0].name)+(s>0?", "+fm.formatSize(s):""));return}$.each(files,function(i,file){c++,s+=parseInt(file.size)||0}),sel.html(c?titlesel+": "+c+", "+titlesize+": "+fm.formatSize(s):"&nbsp;")})})},$.fn.elfindertoolbar=function(fm,opts){return this.not(".elfinder-toolbar").each(function(){var commands=fm._commands,self=$(this).addClass("ui-helper-clearfix ui-widget-header ui-corner-top elfinder-toolbar"),panels=opts||[],l=panels.length,i,cmd,panel,button;self.prev().length&&self.parent().prepend(this);while(l--)if(panels[l]){panel=$('<div class="ui-widget-content ui-corner-all elfinder-buttonset"/>'),i=panels[l].length;while(i--)if(cmd=commands[panels[l][i]])button="elfinder"+cmd.options.ui,$.fn[button]&&panel.prepend($("<div/>")[button](cmd));panel.children().length&&self.prepend(panel),panel.children(":not(:last),:not(:first):not(:last)").after('<span class="ui-widget-content elfinder-toolbar-button-separator"/>')}self.children().length&&self.show()}),this},$.fn.elfindertree=function(fm,opts){var treeclass=fm.res("class","tree");return this.not("."+treeclass).each(function(){var c="class",root=fm.res(c,"treeroot"),openRoot=opts.openRootOnLoad,subtree=fm.res(c,"navsubtree"),navdir=fm.res(c,"treedir"),collapsed=fm.res(c,"navcollapse"),expanded=fm.res(c,"navexpand"),loaded="elfinder-subtree-loaded",arrow=fm.res(c,"navarrow"),active=fm.res(c,"active"),dropover=fm.res(c,"adroppable"),hover=fm.res(c,"hover"),disabled=fm.res(c,"disabled"),draggable=fm.res(c,"draggable"),droppable=fm.res(c,"droppable"),droppableopts=$.extend({},fm.droppable,{hoverClass:hover+" "+dropover,over:function(){var link=$(this);link.is("."+collapsed+":not(."+expanded+")")&&setTimeout(function(){link.is("."+dropover)&&link.children("."+arrow).click()},500)}}),spinner=$(fm.res("tpl","navspinner")),tpl=fm.res("tpl","navdir"),ptpl=fm.res("tpl","perms"),stpl=fm.res("tpl","symlink"),replace={id:function(dir){return fm.navHash2Id(dir.hash)},cssclass:function(dir){return(dir.phash?"":root)+" "+navdir+" "+fm.perms2class(dir)+" "+(dir.dirs&&!dir.link?collapsed:"")},permissions:function(dir){return!dir.read||!dir.write?ptpl:""},symlink:function(dir){return dir.alias?stpl:""}},itemhtml=function(dir){return dir.name=fm.escape(dir.name),tpl.replace(/(?:\{([a-z]+)\})/ig,function(m,key){return dir[key]||(replace[key]?replace[key](dir):"")})},filter=function(files){return $.map(files||[],function(f){return f.mime=="directory"?f:null})},findSubtree=function(hash){return hash?tree.find("#"+fm.navHash2Id(hash)).next("."+subtree):tree},findSibling=function(subtree,dir){var node=subtree.children(":first"),info;while(node.length){if((info=fm.file(fm.navId2Hash(node.children("[id]").attr("id"))))&&dir.name.localeCompare(info.name)<0)return node;node=node.next()}return $("")},updateTree=function(dirs){var length=dirs.length,orphans=[],i,dir,html,parent,sibling;for(i=0;i<length;i++){dir=dirs[i];if(tree.find("#"+fm.navHash2Id(dir.hash)).length)continue;(parent=findSubtree(dir.phash)).length?(html=itemhtml(dir),dir.phash&&(sibling=findSibling(parent,dir)).length?sibling.before(html):parent.append(html)):orphans.push(dir)}if(orphans.length&&orphans.length<length)return updateTree(orphans);updateDroppable()},sync=function(){var cwd=fm.cwd().hash,current=tree.find("#"+fm.navHash2Id(cwd)),rootNode;openRoot&&(rootNode=tree.find("#"+fm.navHash2Id(fm.root())),rootNode.is("."+loaded)&&rootNode.addClass(expanded).next("."+subtree).show(),openRoot=!1),current.is("."+active)||(tree.find("."+navdir+"."+active).removeClass(active),current.addClass(active)),opts.syncTree&&(current.length?current.parentsUntil("."+root).filter("."+subtree).show().prev("."+navdir).addClass(expanded):fm.newAPI&&fm.request({data:{cmd:"parents",target:cwd},preventFail:!0}).done(function(data){var dirs=filter(data.tree);updateTree(dirs),updateArrows(dirs,loaded),cwd==fm.cwd().hash&&sync()}))},updateDroppable=function(){tree.find("."+navdir+":not(."+droppable+",.elfinder-ro,.elfinder-na)").droppable(droppableopts)},updateArrows=function(dirs,cls){var sel=cls==loaded?"."+collapsed+":not(."+loaded+")":":not(."+collapsed+")";$.each(dirs,function(i,dir){tree.find("#"+fm.navHash2Id(dir.phash)+sel).filter(function(){return $(this).next("."+subtree).children().length>0}).addClass(cls)})},tree=$(this).addClass(treeclass).delegate("."+navdir,"hover",function(e){var link=$(this),enter=e.type=="mouseenter";link.is("."+dropover+" ,."+disabled)||(enter&&!link.is("."+root+",."+draggable+",.elfinder-na,.elfinder-wo")&&link.draggable(fm.draggable),link.toggleClass(hover,enter))}).delegate("."+navdir,"dropover dropout drop",function(e){$(this)[e.type=="dropover"?"addClass":"removeClass"](dropover+" "+hover)}).delegate("."+navdir,"click",function(e){var link=$(this),hash=fm.navId2Hash(link.attr("id")),file=fm.file(hash);fm.trigger("searchend"),hash!=fm.cwd().hash&&!link.is("."+disabled)?fm.exec("open",file.thash||hash):link.is("."+collapsed)&&link.children("."+arrow).click()}).delegate("."+navdir+"."+collapsed+" ."+arrow,"click",function(e){var arrow=$(this),link=arrow.parent("."+navdir),stree=link.next("."+subtree);e.stopPropagation(),link.is("."+loaded)?(link.toggleClass(expanded),stree.slideToggle()):(spinner.insertBefore(arrow),link.removeClass(collapsed),fm.request({cmd:"tree",target:fm.navId2Hash(link.attr("id"))}).done(function(data){updateTree(filter(data.tree)),stree.children().length&&(link.addClass(collapsed+" "+expanded),stree.slideDown()),sync()}).always(function(data){spinner.remove(),link.addClass(loaded)}))}).delegate("."+navdir,"contextmenu",function(e){e.preventDefault(),fm.trigger("contextmenu",{type:"navbar",targets:[fm.navId2Hash($(this).attr("id"))],x:e.clientX,y:e.clientY})});tree.parent().find(".elfinder-navbar").append(tree).show(),fm.open(function(e){var data=e.data,dirs=filter(data.files);data.init&&tree.empty(),dirs.length&&(updateTree(dirs),updateArrows(dirs,loaded)),sync()}).add(function(e){var dirs=filter(e.data.added);dirs.length&&(updateTree(dirs),updateArrows(dirs,collapsed))}).change(function(e){var dirs=filter(e.data.changed),l=dirs.length,dir,node,tmp,realParent,reqParent,realSibling,reqSibling,isExpanded,isLoaded;while(l--){dir=dirs[l];if((node=tree
.find("#"+fm.navHash2Id(dir.hash))).length){if(dir.phash){realParent=node.closest("."+subtree),reqParent=findSubtree(dir.phash),realSibling=node.parent().next(),reqSibling=findSibling(reqParent,dir);if(!reqParent.length)continue;if(reqParent[0]!==realParent[0]||realSibling.get(0)!==reqSibling.get(0))reqSibling.length?reqSibling.before(node):reqParent.append(node)}isExpanded=node.is("."+expanded),isLoaded=node.is("."+loaded),tmp=$(itemhtml(dir)),node.replaceWith(tmp.children("."+navdir)),dir.dirs&&(isExpanded||isLoaded)&&(node=tree.find("#"+fm.navHash2Id(dir.hash)))&&node.next("."+subtree).children().length&&(isExpanded&&node.addClass(expanded),isLoaded&&node.addClass(loaded))}}sync(),updateDroppable()}).remove(function(e){var dirs=e.data.removed,l=dirs.length,node,stree;while(l--)(node=tree.find("#"+fm.navHash2Id(dirs[l]))).length&&(stree=node.closest("."+subtree),node.parent().detach(),stree.children().length||stree.hide().prev("."+navdir).removeClass(collapsed+" "+expanded+" "+loaded))}).bind("search searchend",function(e){tree.find("#"+fm.navHash2Id(fm.cwd().hash))[e.type=="search"?"removeClass":"addClass"](active)}).bind("lockfiles unlockfiles",function(e){var lock=e.type=="lockfiles",act=lock?"disable":"enable",dirs=$.map(e.data.files||[],function(h){var dir=fm.file(h);return dir&&dir.mime=="directory"?h:null});$.each(dirs,function(i,hash){var dir=tree.find("#"+fm.navHash2Id(hash));dir.length&&(dir.is("."+draggable)&&dir.draggable(act),dir.is("."+droppable)&&dir.droppable(active),dir[lock?"addClass":"removeClass"](disabled))})})}),this},$.fn.elfinderuploadbutton=function(cmd){return this.each(function(){var button=$(this).elfinderbutton(cmd).unbind("click"),form=$("<form/>").appendTo(button),input=$('<input type="file" multiple="true"/>').change(function(){var _input=$(this);_input.val()&&(cmd.exec({input:_input.remove()[0]}),input.clone(!0).appendTo(form))});form.append(input.clone(!0)),cmd.change(function(){form[cmd.disabled()?"hide":"show"]()}).change()})},$.fn.elfinderviewbutton=function(cmd){return this.each(function(){var button=$(this).elfinderbutton(cmd),icon=button.children(".elfinder-button-icon");cmd.change(function(){var icons=cmd.value=="icons";icon.toggleClass("elfinder-button-icon-view-list",icons),button.attr("title",cmd.fm.i18n(icons?"viewlist":"viewicons"))})})},$.fn.elfinderworkzone=function(fm){var cl="elfinder-workzone";return this.not("."+cl).each(function(){var wz=$(this).addClass(cl),wdelta=wz.outerHeight(!0)-wz.height(),parent=wz.parent();parent.add(window).bind("resize",function(){var height=parent.height();parent.children(":visible:not(."+cl+")").each(function(){var ch=$(this);ch.css("position")!="absolute"&&(height-=ch.outerHeight(!0))}),wz.height(height-wdelta)})}),this},elFinder.prototype.commands.archive=function(){var self=this,fm=self.fm,mimes=[];this.variants=[],this.disableOnSearch=!0,fm.bind("open reload",function(){self.variants=[],$.each(mimes=fm.option("archivers").create||[],function(i,mime){self.variants.push([mime,fm.mime2kind(mime)])}),self.change()}),this.getstate=function(){return!this._disabled&&mimes.length&&fm.selected().length&&fm.cwd().write?0:-1},this.exec=function(hashes,type){var files=this.files(hashes),cnt=files.length,mime=type||mimes[0],cwd=fm.cwd(),error=["errArchive","errPerm"],dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}),i;if(!(this.enabled()&&cnt&&mimes.length&&$.inArray(mime,mimes)!==-1))return dfrd.reject();if(!cwd.write)return dfrd.reject(error);for(i=0;i<cnt;i++)if(!files[i].read)return dfrd.reject(error);return fm.request({data:{cmd:"archive",targets:this.hashes(hashes),type:mime},notify:{type:"archive",cnt:1},syncOnFail:!0})}},elFinder.prototype.commands.back=function(){this.alwaysEnabled=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"ctrl+left backspace"}],this.getstate=function(){return this.fm.history.canBack()?0:-1},this.exec=function(){return this.fm.history.back()}},elFinder.prototype.commands.copy=function(){this.shortcuts=[{pattern:"ctrl+c ctrl+insert"}],this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return cnt&&$.map(sel,function(f){return f.phash&&f.read?f:null}).length==cnt?0:-1},this.exec=function(hashes){var fm=this.fm,dfrd=$.Deferred().fail(function(error){fm.error(error)});return $.each(this.files(hashes),function(i,file){if(!file.read||!file.phash)return!dfrd.reject(["errCopy",file.name,"errPerm"])}),dfrd.isRejected()?dfrd:dfrd.resolve(fm.clipboard(this.hashes(hashes)))}},elFinder.prototype.commands.cut=function(){this.shortcuts=[{pattern:"ctrl+x shift+insert"}],this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return cnt&&$.map(sel,function(f){return f.phash&&f.read&&!f.locked?f:null}).length==cnt?0:-1},this.exec=function(hashes){var fm=this.fm,dfrd=$.Deferred().fail(function(error){fm.error(error)});return $.each(this.files(hashes),function(i,file){if(!file.read||!file.phash)return!dfrd.reject(["errCopy",file.name,"errPerm"]);if(file.locked)return!dfrd.reject(["errLocked",file.name])}),dfrd.isRejected()?dfrd:dfrd.resolve(fm.clipboard(this.hashes(hashes),!0))}},elFinder.prototype.commands.download=function(){var self=this,fm=this.fm,filter=function(hashes){return $.map(self.files(hashes),function(f){return f.mime=="directory"?null:f})};this.shortcuts=[{pattern:"shift+enter"}],this.getstate=function(){var sel=this.fm.selected(),cnt=sel.length;return!this._disabled&&cnt&&(!$.browser.msie||cnt==1)&&cnt==filter(sel).length?0:-1},this.exec=function(hashes){var fm=this.fm,base=fm.options.url,files=filter(hashes),dfrd=$.Deferred(),iframes="",cdata="",i,url;if(this.disabled())return dfrd.reject();if(fm.oldAPI)return fm.error("errCmdNoSupport"),dfrd.reject();$.each(fm.options.customData||{},function(k,v){cdata+="&"+k+"="+v}),base+=base.indexOf("?")===-1?"?":"&";for(i=0;i<files.length;i++)iframes+='<iframe class="downloader" id="downloader-'+files[i].hash+'" style="display:none" src="'+base+"cmd=file&target="+files[i].hash+"&download=1"+cdata+'"/>';return $(iframes).appendTo("body").ready(function(){setTimeout(function(){$(iframes).each(function(){$("#"+$(this).attr("id")).remove()})},$.browser.mozilla?2e4+1e4*i:1e3)}),fm.trigger("download",{files:files}),dfrd.resolve(hashes)}},elFinder.prototype.commands.duplicate=function(){var fm=this.fm;this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return!this._disabled&&cnt&&fm.cwd().write&&$.map(sel,function(f){return f.phash&&f.read?f:null}).length==cnt?0:-1},this.exec=function(hashes){var fm=this.fm,files=this.files(hashes),cnt=files.length,dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}),args=[];return!cnt||this._disabled?dfrd.reject():($.each(files,function(i,file){if(!file.read||!fm.file(file.phash).write)return!dfrd.reject(["errCopy",file.name,"errPerm"])}),dfrd.isRejected()?dfrd:fm.request({data:{cmd:"duplicate",targets:this.hashes(hashes)},notify:{type:"copy",cnt:cnt}}))}},elFinder.prototype.commands.edit=function(){var self=this,fm=this.fm,mimes=fm.res("mimes","text")||[],filter=function(files){return $.map(files,function(file){return(file.mime.indexOf("text/")===0||$.inArray(file.mime,mimes)!==-1)&&file.mime.indexOf("text/rtf")&&(!self.onlyMimes.length||$.inArray(file.mime,self.onlyMimes)!==-1)&&file.read&&file.write?file:null})},dialog=function(id,file,content){var dfrd=$.Deferred(),ta=$('<textarea class="elfinder-file-edit" rows="20" id="'+id+'-ta">'+fm.escape(content)+"</textarea>"),save=function(){ta.editor&&ta.editor.save(ta[0],ta.editor.instance),dfrd.resolve(ta.getContent()),ta.elfinderdialog("close")},cancel=function(){dfrd.reject(),ta.elfinderdialog("close")},opts={title:file.name,width:self.options.dialogWidth||450,buttons:{},close:function(){ta.editor&&ta.editor.close(ta[0],ta.editor.instance),$(this).elfinderdialog("destroy")},open:function(){fm.disable(),ta.focus(),ta[0].setSelectionRange&&ta[0].setSelectionRange(0,0),ta.editor&&ta.editor.load(ta[0])}};return ta.getContent=function(){return ta.val()},$.each(self.options.editors||[],function(i,editor){if($.inArray(file.mime,editor.mimes||[])!==-1&&typeof editor.load=="function"&&typeof editor.save=="function")return ta.editor={load:editor.load,save:editor
.save,close:typeof editor.close=="function"?editor.close:function(){},instance:null},!1}),ta.editor||ta.keydown(function(e){var code=e.keyCode,value,start;e.stopPropagation(),code==9&&(e.preventDefault(),this.setSelectionRange&&(value=this.value,start=this.selectionStart,this.value=value.substr(0,start)+"	"+value.substr(this.selectionEnd),start+=1,this.setSelectionRange(start,start)));if(e.ctrlKey||e.metaKey){if(code==81||code==87)e.preventDefault(),cancel();code==83&&(e.preventDefault(),save())}}),opts.buttons[fm.i18n("Save")]=save,opts.buttons[fm.i18n("Cancel")]=cancel,fm.dialog(ta,opts).attr("id",id),dfrd.promise()},edit=function(file){var hash=file.hash,opts=fm.options,dfrd=$.Deferred(),data={cmd:"file",target:hash},url=fm.url(hash)||fm.options.url,id="edit-"+fm.namespace+"-"+file.hash,d=fm.getUI().find("#"+id),error;return d.length?(d.elfinderdialog("toTop"),dfrd.resolve()):!file.read||!file.write?(error=["errOpen",file.name,"errPerm"],fm.error(error),dfrd.reject(error)):(fm.request({data:{cmd:"get",target:hash},notify:{type:"openfile",cnt:1},syncOnFail:!0}).done(function(data){dialog(id,file,data.content).done(function(content){fm.request({options:{type:"post"},data:{cmd:"put",target:hash,content:content},notify:{type:"save",cnt:1},syncOnFail:!0}).fail(function(error){dfrd.reject(error)}).done(function(data){data.changed&&data.changed.length&&fm.change(data),dfrd.resolve(data)})})}).fail(function(error){dfrd.reject(error)}),dfrd.promise())};this.shortcuts=[{pattern:"ctrl+e"}],this.init=function(){this.onlyMimes=this.options.mimes||[]},this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return!this._disabled&&cnt&&filter(sel).length==cnt?0:-1},this.exec=function(hashes){var files=filter(this.files(hashes)),list=[],file;if(this.disabled())return $.Deferred().reject();while(file=files.shift())list.push(edit(file));return list.length?$.when.apply(null,list):$.Deferred().reject()}},elFinder.prototype.commands.extract=function(){var self=this,fm=self.fm,mimes=[],filter=function(files){return $.map(files,function(file){return file.read&&$.inArray(file.mime,mimes)!==-1?file:null})};this.disableOnSearch=!0,fm.bind("open reload",function(){mimes=fm.option("archivers").extract||[],self.change()}),this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return!this._disabled&&cnt&&this.fm.cwd().write&&filter(sel).length==cnt?0:-1},this.exec=function(hashes){var files=this.files(hashes),dfrd=$.Deferred(),cnt=files.length,complete=cnt,i,file,error;if(!(this.enabled()&&cnt&&mimes.length))return dfrd.reject();for(i=0;i<cnt;i++){file=files[i];if(!file.read||!fm.file(file.phash).write)return error=["errExtract",file.name,"errPerm"],fm.error(error),dfrd.reject(error);if($.inArray(file.mime,mimes)===-1)return error=["errExtract",file.name,"errNoArchive"],fm.error(error),dfrd.reject(error);fm.request({data:{cmd:"extract",target:file.hash},notify:{type:"extract",cnt:1},syncOnFail:!0}).fail(function(error){dfrd.isRejected()||dfrd.reject(error)}).done(function(){complete--,complete==0&&dfrd.resolve()})}return dfrd}},elFinder.prototype.commands.forward=function(){this.alwaysEnabled=!0,this.updateOnSelect=!0,this.shortcuts=[{pattern:"ctrl+right"}],this.getstate=function(){return this.fm.history.canForward()?0:-1},this.exec=function(){return this.fm.history.forward()}},elFinder.prototype.commands.getfile=function(){var self=this,fm=this.fm,filter=function(files){var o=self.options;return files=$.map(files,function(file){return file.mime!="directory"||o.folders?file:null}),o.multiple||files.length==1?files:[]};this.alwaysEnabled=!0,this.callback=fm.options.getFileCallback,this._disabled=typeof this.callback=="function",this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return this.callback&&cnt&&filter(sel).length==cnt?0:-1},this.exec=function(hashes){var fm=this.fm,opts=this.options,files=this.files(hashes),cnt=files.length,url=fm.option("url"),tmb=fm.option("tmbUrl"),dfrd=$.Deferred().done(function(data){fm.trigger("getfile",{files:data}),self.callback(data,fm),opts.oncomplete=="close"?fm.hide():opts.oncomplete=="destroy"&&fm.destroy()}),result=function(file){return opts.onlyURL?opts.multiple?$.map(files,function(f){return f.url}):files[0].url:opts.multiple?files:files[0]},req=[],i,file,dim;if(this.getstate()==-1)return dfrd.reject();for(i=0;i<cnt;i++){file=files[i];if(file.mime=="directory"&&!opts.folders)return dfrd.reject();file.baseUrl=url,file.url=fm.url(file.hash),file.path=fm.path(file.hash),file.tmb&&file.tmb!=1&&(file.tmb=tmb+file.tmb),!file.width&&!file.height&&(file.dim?(dim=file.dim.split("x"),file.width=dim[0],file.height=dim[1]):file.mime.indexOf("image")!==-1&&req.push(fm.request({data:{cmd:"dim",target:file.hash},preventDefault:!0}).done($.proxy(function(data){data.dim&&(dim=data.dim.split("x"),this.width=dim[0],this.height=dim[1]),this.dim=data.dim},files[i]))))}return req.length?($.when.apply(null,req).always(function(){dfrd.resolve(result(files))}),dfrd):dfrd.resolve(result(files))}},elFinder.prototype.commands.help=function(){var fm=this.fm,self=this,linktpl='<div class="elfinder-help-link"> <a href="{url}">{link}</a></div>',atpl='<div class="elfinder-help-team"><div>{author}</div>{work}</div>',url=/\{url\}/,link=/\{link\}/,author=/\{author\}/,work=/\{work\}/,r="replace",prim="ui-priority-primary",sec="ui-priority-secondary",lic="elfinder-help-license",tab='<li class="ui-state-default ui-corner-top"><a href="#{id}">{title}</a></li>',html=['<div class="ui-tabs ui-widget ui-widget-content ui-corner-all elfinder-help">','<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">'],stpl='<div class="elfinder-help-shortcut"><div class="elfinder-help-shortcut-pattern">{pattern}</div> {descrip}</div>',sep='<div class="elfinder-help-separator"/>',about=function(){html.push('<div id="about" class="ui-tabs-panel ui-widget-content ui-corner-bottom"><div class="elfinder-help-logo"/>'),html.push("<h3>elFinder</h3>"),html.push('<div class="'+prim+'">'+fm.i18n("webfm")+"</div>"),html.push('<div class="'+sec+'">'+fm.i18n("ver")+": "+fm.version+", "+fm.i18n("protocolver")+": "+fm.api+"</div>"),html.push('<div class="'+sec+'">jQuery/jQuery UI: '+$().jquery+"/"+$.ui.version+"</div>"),html.push(sep),html.push(linktpl[r](url,"http://elfinder.org/")[r](link,fm.i18n("homepage"))),html.push(linktpl[r](url,"https://github.com/Studio-42/elFinder/wiki")[r](link,fm.i18n("docs"))),html.push(linktpl[r](url,"https://github.com/Studio-42/elFinder")[r](link,fm.i18n("github"))),html.push(linktpl[r](url,"http://twitter.com/elrte_elfinder")[r](link,fm.i18n("twitter"))),html.push(sep),html.push('<div class="'+prim+'">'+fm.i18n("team")+"</div>"),html.push(atpl[r](author,'Dmitry "dio" Levashov &lt;dio@std42.ru&gt;')[r](work,fm.i18n("chiefdev"))),html.push(atpl[r](author,"Troex Nevelin &lt;troex@fury.scancode.ru&gt;")[r](work,fm.i18n("maintainer"))),html.push(atpl[r](author,"Alexey Sukhotin &lt;strogg@yandex.ru&gt;")[r](work,fm.i18n("contributor"))),html.push(atpl[r](author,"Naoki Sawada &lt;hypweb@gmail.com&gt;")[r](work,fm.i18n("contributor"))),fm.i18[fm.lang].translator&&html.push(atpl[r](author,fm.i18[fm.lang].translator)[r](work,fm.i18n("translator")+" ("+fm.i18[fm.lang].language+")")),html.push(sep),html.push('<div class="'+lic+'">'+fm.i18n("icons")+': <a href="http://pixelmixer.ru/" target="_blank">Pixelmixer</a>, <a href="http://p.yusukekamiyamane.com" target="_blank">Fugue</a></div>'),html.push(sep),html.push('<div class="'+lic+'">Licence: BSD Licence</div>'),html.push('<div class="'+lic+'">Copyright © 2009-2011, Studio 42</div>'),html.push('<div class="'+lic+'">„ …'+fm.i18n("dontforget")+" ”</div>"),html.push("</div>")},shortcuts=function(){var sh=fm.shortcuts();html.push('<div id="shortcuts" class="ui-tabs-panel ui-widget-content ui-corner-bottom">'),sh.length?(html.push('<div class="ui-widget-content elfinder-help-shortcuts">'),$.each(sh,function(i,s){html.push(stpl.replace(/\{pattern\}/,s[0]).replace(/\{descrip\}/,s[1]))}),html.push("</div>")):html.push('<div class="elfinder-help-disabled">'+fm.i18n("shortcutsof")+"</div>"),html.push("</div>")},help=function(){html.push('<div id="help" class="ui-tabs-panel ui-widget-content ui-corner-bottom">'
),html.push('<a href="http://elfinder.org/forum/" target="_blank" class="elfinder-dont-panic"><span>DON\'T PANIC</span></a>'),html.push("</div>")},content;this.alwaysEnabled=!0,this.updateOnSelect=!1,this.state=0,this.shortcuts=[{pattern:"f1",description:this.title}],setTimeout(function(){var parts=self.options.view||["about","shortcuts","help"];$.each(parts,function(i,title){html.push(tab[r](/\{id\}/,title)[r](/\{title\}/,fm.i18n(title)))}),html.push("</ul>"),$.inArray("about",parts)!==-1&&about(),$.inArray("shortcuts",parts)!==-1&&shortcuts(),$.inArray("help",parts)!==-1&&help(),html.push("</div>"),content=$(html.join("")),content.find(".ui-tabs-nav li").hover(function(){$(this).toggleClass("ui-state-hover")}).children().click(function(e){var link=$(this);e.preventDefault(),e.stopPropagation(),link.is(".ui-tabs-selected")||(link.parent().addClass("ui-tabs-selected ui-state-active").siblings().removeClass("ui-tabs-selected").removeClass("ui-state-active"),content.find(".ui-tabs-panel").hide().filter(link.attr("href")).show())}).filter(":first").click()},200),this.getstate=function(){return 0},this.exec=function(){this.dialog||(this.dialog=this.fm.dialog(content,{title:this.title,width:530,autoOpen:!1,destroyOnClose:!1})),this.dialog.elfinderdialog("open").find(".ui-tabs-nav li a:first").click()}},elFinder.prototype.commands.home=function(){this.title="Home",this.alwaysEnabled=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"ctrl+home ctrl+shift+up",description:"Home"}],this.getstate=function(){var root=this.fm.root(),cwd=this.fm.cwd().hash;return root&&cwd&&root!=cwd?0:-1},this.exec=function(){return this.fm.exec("open",this.fm.root())}},elFinder.prototype.commands.info=function(){var m="msg",fm=this.fm,spclass="elfinder-info-spinner",msg={calc:fm.i18n("calc"),size:fm.i18n("size"),unknown:fm.i18n("unknown"),path:fm.i18n("path"),aliasfor:fm.i18n("aliasfor"),modify:fm.i18n("modify"),perms:fm.i18n("perms"),locked:fm.i18n("locked"),dim:fm.i18n("dim"),kind:fm.i18n("kind"),files:fm.i18n("files"),folders:fm.i18n("folders"),items:fm.i18n("items"),yes:fm.i18n("yes"),no:fm.i18n("no"),link:fm.i18n("link")};this.tpl={main:'<div class="ui-helper-clearfix elfinder-info-title"><span class="elfinder-cwd-icon {class} ui-corner-all"/>{title}</div><table class="elfinder-info-tb">{content}</table>',itemTitle:'<strong>{name}</strong><span class="elfinder-info-kind">{kind}</span>',groupTitle:"<strong>{items}: {num}</strong>",row:"<tr><td>{label} : </td><td>{value}</td></tr>",spinner:'<span>{text}</span> <span class="'+spclass+'"/>'},this.alwaysEnabled=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"ctrl+i"}],this.init=function(){$.each(msg,function(k,v){msg[k]=fm.i18n(v)})},this.getstate=function(){return 0},this.exec=function(hashes){var self=this,fm=this.fm,tpl=this.tpl,row=tpl.row,files=this.files(hashes),cnt=files.length,content=[],view=tpl.main,l="{label}",v="{value}",opts={title:this.title,width:"auto",close:function(){$(this).elfinderdialog("destroy")}},count=[],replSpinner=function(msg){dialog.find("."+spclass).parent().text(msg)},id=fm.namespace+"-info-"+$.map(files,function(f){return f.hash}).join("-"),dialog=fm.getUI().find("#"+id),size,tmb,file,title,dcnt;if(!cnt)return $.Deferred().reject();if(dialog.length)return dialog.elfinderdialog("toTop"),$.Deferred().resolve();cnt==1?(file=files[0],view=view.replace("{class}",fm.mime2class(file.mime)),title=tpl.itemTitle.replace("{name}",file.name).replace("{kind}",fm.mime2kind(file)),file.tmb&&(tmb=fm.option("tmbUrl")+file.tmb),file.read?file.mime!="directory"||file.alias?size=fm.formatSize(file.size):(size=tpl.spinner.replace("{text}",msg.calc),count.push(file.hash)):size=msg.unknown,content.push(row.replace(l,msg.size).replace(v,size)),file.alias&&content.push(row.replace(l,msg.aliasfor).replace(v,file.alias)),content.push(row.replace(l,msg.path).replace(v,fm.escape(fm.path(file.hash)))),file.read&&content.push(row.replace(l,msg.link).replace(v,'<a href="'+fm.url(file.hash)+'" target="_blank">'+file.name+"</a>")),file.dim?content.push(row.replace(l,msg.dim).replace(v,file.dim)):file.mime.indexOf("image")!==-1&&(file.width&&file.height?content.push(row.replace(l,msg.dim).replace(v,file.width+"x"+file.height)):(content.push(row.replace(l,msg.dim).replace(v,tpl.spinner.replace("{text}",msg.calc))),fm.request({data:{cmd:"dim",target:file.hash},preventDefault:!0}).fail(function(){replSpinner(msg.unknown)}).done(function(data){replSpinner(data.dim||msg.unknown)}))),content.push(row.replace(l,msg.modify).replace(v,fm.formatDate(file))),content.push(row.replace(l,msg.perms).replace(v,fm.formatPermissions(file))),content.push(row.replace(l,msg.locked).replace(v,file.locked?msg.yes:msg.no))):(view=view.replace("{class}","elfinder-cwd-icon-group"),title=tpl.groupTitle.replace("{items}",msg.items).replace("{num}",cnt),dcnt=$.map(files,function(f){return f.mime=="directory"?1:null}).length,dcnt?(content.push(row.replace(l,msg.kind).replace(v,dcnt==cnt?msg.folders:msg.folders+" "+dcnt+", "+msg.files+" "+(cnt-dcnt))),content.push(row.replace(l,msg.size).replace(v,tpl.spinner.replace("{text}",msg.calc))),count=$.map(files,function(f){return f.hash})):(size=0,$.each(files,function(h,f){var s=parseInt(f.size);s>=0&&size>=0?size+=s:size="unknown"}),content.push(row.replace(l,msg.kind).replace(v,msg.files)),content.push(row.replace(l,msg.size).replace(v,fm.formatSize(size))))),view=view.replace("{title}",title).replace("{content}",content.join("")),dialog=fm.dialog(view,opts),dialog.attr("id",id),tmb&&$("<img/>").load(function(){dialog.find(".elfinder-cwd-icon").css("background",'url("'+tmb+'") center center no-repeat')}).attr("src",tmb),count.length&&fm.request({data:{cmd:"size",targets:count},preventDefault:!0}).fail(function(){replSpinner(msg.unknown)}).done(function(data){var size=parseInt(data.size);fm.log(data.size),replSpinner(size>=0?fm.formatSize(size):msg.unknown)})}},elFinder.prototype.commands.mkdir=function(){this.disableOnSearch=!0,this.updateOnSelect=!1,this.mime="directory",this.prefix="untitled folder",this.exec=$.proxy(this.fm.res("mixin","make"),this),this.shortcuts=[{pattern:"ctrl+shift+n"}],this.getstate=function(){return!this._disabled&&this.fm.cwd().write?0:-1}},elFinder.prototype.commands.mkfile=function(){this.disableOnSearch=!0,this.updateOnSelect=!1,this.mime="text/plain",this.prefix="untitled file.txt",this.exec=$.proxy(this.fm.res("mixin","make"),this),this.getstate=function(){return!this._disabled&&this.fm.cwd().write?0:-1}},elFinder.prototype.commands.netmount=function(){var self=this;this.alwaysEnabled=!0,this.updateOnSelect=!1,this.drivers=[],this.handlers={load:function(){this.drivers=this.fm.netDrivers}},this.getstate=function(){return this.drivers.length?0:-1},this.exec=function(){var fm=self.fm,dfrd=$.Deferred(),create=function(){var inputs={protocol:$("<select/>"),host:$('<input type="text"/>'),port:$('<input type="text"/>'),path:$('<input type="text" value="/"/>'),user:$('<input type="text"/>'),pass:$('<input type="password"/>')},opts={title:fm.i18n("netMountDialogTitle"),resizable:!1,modal:!0,destroyOnClose:!0,close:function(){delete self.dialog,!dfrd.isResolved()&&!dfrd.isRejected()&&dfrd.reject()},buttons:{}},content=$('<table class="elfinder-info-tb elfinder-netmount-tb"/>');return $.each(self.drivers,function(i,protocol){inputs.protocol.append('<option value="'+protocol+'">'+fm.i18n(protocol)+"</option>")}),$.each(inputs,function(name,input){name!="protocol"&&input.addClass("ui-corner-all"),content.append($("<tr/>").append($("<td>"+fm.i18n(name)+"</td>")).append($("<td/>").append(input)))}),opts.buttons[fm.i18n("btnMount")]=function(){var data={cmd:"netmount"};$.each(inputs,function(name,input){var val=$.trim(input.val());val&&(data[name]=val)});if(!data.host)return self.fm.trigger("error",{error:"errNetMountHostReq"});self.fm.request({data:data,notify:{type:"netmount",cnt:1}}).done(function(){dfrd.resolve()}).fail(function(error){dfrd.reject(error)}),self.dialog.elfinderdialog("close")},opts.buttons[fm.i18n("btnCancel")]=function(){self.dialog.elfinderdialog("close")},fm.dialog(content,opts)};return self.dialog||(self.dialog=create()),dfrd.promise()}},elFinder.prototype.
commands.open=function(){this.alwaysEnabled=!0,this._handlers={dblclick:function(e){e.preventDefault(),this.exec()},"select enable disable reload":function(e){this.update(e.type=="disable"?-1:void 0)}},this.shortcuts=[{pattern:"ctrl+down numpad_enter"+(this.fm.OS!="mac"&&" enter")}],this.getstate=function(sel){var sel=this.files(sel),cnt=sel.length;return cnt==1?0:cnt?$.map(sel,function(file){return file.mime=="directory"?null:file}).length==cnt?0:-1:-1},this.exec=function(hashes){var fm=this.fm,dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}),files=this.files(hashes),cnt=files.length,file,url,s,w;if(!cnt)return dfrd.reject();if(cnt==1&&(file=files[0])&&file.mime=="directory")return file&&!file.read?dfrd.reject(["errOpen",file.name,"errPerm"]):fm.request({data:{cmd:"open",target:file.thash||file.hash},notify:{type:"open",cnt:1,hideCnt:!0},syncOnFail:!0});files=$.map(files,function(file){return file.mime!="directory"?file:null});if(cnt!=files.length)return dfrd.reject();cnt=files.length;while(cnt--){file=files[cnt];if(!file.read)return dfrd.reject(["errOpen",file.name,"errPerm"]);(url=fm.url(file.hash))||(url=fm.options.url,url=url+(url.indexOf("?")===-1?"?":"&")+(fm.oldAPI?"cmd=open&current="+file.phash:"cmd=file")+"&target="+file.hash),w="",file.dim&&(s=file.dim.split("x"),w="width="+(parseInt(s[0])+20)+",height="+(parseInt(s[1])+20));if(!window.open(url,"_blank",w+",top=50,left=50,scrollbars=yes,resizable=yes"))return dfrd.reject("errPopup")}return dfrd.resolve(hashes)}},elFinder.prototype.commands.paste=function(){this.updateOnSelect=!1,this.handlers={changeclipboard:function(){this.update()}},this.shortcuts=[{pattern:"ctrl+v shift+insert"}],this.getstate=function(dst){if(this._disabled)return-1;if(dst){if($.isArray(dst)){if(dst.length!=1)return-1;dst=this.fm.file(dst[0])}}else dst=this.fm.cwd();return this.fm.clipboard().length&&dst.mime=="directory"&&dst.write?0:-1},this.exec=function(dst){var self=this,fm=self.fm,dst=dst?this.files(dst)[0]:fm.cwd(),files=fm.clipboard(),cnt=files.length,cut=cnt?files[0].cut:!1,error=cut?"errMove":"errCopy",fpaste=[],fcopy=[],dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}),copy=function(files){return files.length&&fm._commands.duplicate?fm.exec("duplicate",files):$.Deferred().resolve()},paste=function(files){var dfrd=$.Deferred(),existed=[],intersect=function(files,names){var ret=[],i=files.length;while(i--)$.inArray(files[i].name,names)!==-1&&ret.unshift(i);return ret},confirm=function(ndx){var i=existed[ndx],file=files[i],last=ndx==existed.length-1;if(!file)return;fm.confirm({title:fm.i18n(cut?"moveFiles":"copyFiles"),text:fm.i18n(["errExists",file.name,"confirmRepl"]),all:!last,accept:{label:"btnYes",callback:function(all){!last&&!all?confirm(++ndx):paste(files)}},reject:{label:"btnNo",callback:function(all){var i;if(all){i=existed.length;while(ndx<i--)files[existed[i]].remove=!0}else files[existed[ndx]].remove=!0;!last&&!all?confirm(++ndx):paste(files)}},cancel:{label:"btnCancel",callback:function(){dfrd.resolve()}}})},valid=function(names){existed=intersect(files,names),existed.length?confirm(0):paste(files)},paste=function(files){var files=$.map(files,function(file){return file.remove?null:file}),cnt=files.length,groups={},args=[],src;if(!cnt)return dfrd.resolve();src=files[0].phash,files=$.map(files,function(f){return f.hash}),fm.request({data:{cmd:"paste",dst:dst.hash,targets:files,cut:cut?1:0,src:src},notify:{type:cut?"move":"copy",cnt:cnt}}).always(function(){dfrd.resolve(),fm.unlockfiles({files:files})})};return self._disabled||!files.length?dfrd.resolve():(fm.oldAPI?paste(files):fm.option("copyOverwrite")?dst.hash==fm.cwd().hash?valid($.map(fm.files(),function(file){return file.phash==dst.hash?file.name:null})):fm.request({data:{cmd:"ls",target:dst.hash},notify:{type:"prepare",cnt:1,hideCnt:!0},preventFail:!0}).always(function(data){valid(data.list||[])}):paste(files),dfrd)},parents,fparents;return!cnt||!dst||dst.mime!="directory"?dfrd.reject():dst.write?(parents=fm.parents(dst.hash),$.each(files,function(i,file){if(!file.read)return!dfrd.reject([error,files[0].name,"errPerm"]);if(cut&&file.locked)return!dfrd.reject(["errLocked",file.name]);if($.inArray(file.hash,parents)!==-1)return!dfrd.reject(["errCopyInItself",file.name]);fparents=fm.parents(file.hash);if($.inArray(dst.hash,fparents)!==-1&&$.map(fparents,function(h){var d=fm.file(h);return d.phash==dst.hash&&d.name==file.name?d:null}).length)return!dfrd.reject(["errReplByChild",file.name]);file.phash==dst.hash?fcopy.push(file.hash):fpaste.push({hash:file.hash,phash:file.phash,name:file.name})}),dfrd.isRejected()?dfrd:$.when(copy(fcopy),paste(fpaste)).always(function(){cut&&fm.clipboard([])})):dfrd.reject([error,files[0].name,"errPerm"])}},elFinder.prototype.commands.quicklook=function(){var self=this,fm=self.fm,closed=0,animated=1,opened=2,state=closed,navicon="elfinder-quicklook-navbar-icon",fullscreen="elfinder-quicklook-fullscreen",navtrigger=function(code){$(document).trigger($.Event("keydown",{keyCode:code,ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1}))},closedCss=function(node){return{opacity:0,width:20,height:fm.view=="list"?1:20,top:node.offset().top+"px",left:node.offset().left+"px"}},openedCss=function(){var win=$(window);return{opacity:1,width:width,height:height,top:parseInt((win.height()-height)/2+win.scrollTop()),left:parseInt((win.width()-width)/2+win.scrollLeft())}},support=function(codec){var media=document.createElement(codec.substr(0,codec.indexOf("/"))),value=!1;try{value=media.canPlayType&&media.canPlayType(codec)}catch(e){}return value&&value!==""&&value!="no"},width,height,parent,cwd,title=$('<div class="elfinder-quicklook-title"/>'),icon=$("<div/>"),info=$('<div class="elfinder-quicklook-info"/>'),fsicon=$('<div class="'+navicon+" "+navicon+'-fullscreen"/>').mousedown(function(e){var win=self.window,full=win.is("."+fullscreen),scroll="scroll."+fm.namespace,$window=$(window);e.stopPropagation(),full?(win.css(win.data("position")).unbind("mousemove"),$window.unbind(scroll).trigger(self.resize).unbind(self.resize),navbar.unbind("mouseenter").unbind("mousemove")):(win.data("position",{left:win.css("left"),top:win.css("top"),width:win.width(),height:win.height()}).css({width:"100%",height:"100%"}),$(window).bind(scroll,function(){win.css({left:parseInt($(window).scrollLeft())+"px",top:parseInt($(window).scrollTop())+"px"})}).bind(self.resize,function(e){self.preview.trigger("changesize")}).trigger(scroll).trigger(self.resize),win.bind("mousemove",function(e){navbar.stop(!0,!0).show().delay(3e3).fadeOut("slow")}).mousemove(),navbar.mouseenter(function(){navbar.stop(!0,!0).show()}).mousemove(function(e){e.stopPropagation()})),navbar.attr("style","").draggable(full?"destroy":{}),win.toggleClass(fullscreen),$(this).toggleClass(navicon+"-fullscreen-off"),$.fn.resizable&&parent.add(win).resizable(full?"enable":"disable").removeClass("ui-state-disabled")}),navbar=$('<div class="elfinder-quicklook-navbar"/>').append($('<div class="'+navicon+" "+navicon+'-prev"/>').mousedown(function(){navtrigger(37)})).append(fsicon).append($('<div class="'+navicon+" "+navicon+'-next"/>').mousedown(function(){navtrigger(39)})).append('<div class="elfinder-quicklook-navbar-separator"/>').append($('<div class="'+navicon+" "+navicon+'-close"/>').mousedown(function(){self.window.trigger("close")}));this.resize="resize."+fm.namespace,this.info=$('<div class="elfinder-quicklook-info-wrapper"/>').append(icon).append(info),this.preview=$('<div class="elfinder-quicklook-preview ui-helper-clearfix"/>').bind("change",function(e){self.info.attr("style","").hide(),icon.removeAttr("class").attr("style",""),info.html("")}).bind("update",function(e){var fm=self.fm,preview=self.preview,file=e.file,tpl='<div class="elfinder-quicklook-info-data">{value}</div>',tmb;file?(!file.read&&e.stopImmediatePropagation(),self.window.data("hash",file.hash),self.preview.unbind("changesize").trigger("change").children().remove(),title.html(fm.escape(file.name)),info.html(tpl.replace(/\{value\}/,file.name)+tpl.replace(/\{value\}/,fm.mime2kind(file))+(file.mime=="directory"?"":tpl.replace(/\{value\}/,fm.formatSize(file.size)))+tpl.replace(/\{value\}/
,fm.i18n("modify")+": "+fm.formatDate(file))),icon.addClass("elfinder-cwd-icon ui-corner-all "+fm.mime2class(file.mime)),file.tmb&&$("<img/>").hide().appendTo(self.preview).load(function(){icon.css("background",'url("'+tmb+'") center center no-repeat'),$(this).remove()}).attr("src",tmb=fm.tmb(file.hash)),self.info.delay(100).fadeIn(10)):e.stopImmediatePropagation()}),this.window=$('<div class="ui-helper-reset ui-widget elfinder-quicklook" style="position:absolute"/>').click(function(e){e.stopPropagation()}).append($('<div class="elfinder-quicklook-titlebar"/>').append(title).append($('<span class="ui-icon ui-icon-circle-close"/>').mousedown(function(e){e.stopPropagation(),self.window.trigger("close")}))).append(this.preview.add(navbar)).append(self.info.hide()).draggable({handle:"div.elfinder-quicklook-titlebar"}).bind("open",function(e){var win=self.window,file=self.value,node;self.closed()&&file&&(node=cwd.find("#"+file.hash)).length&&(state=animated,node.trigger("scrolltoview"),win.css(closedCss(node)).show().animate(openedCss(),550,function(){state=opened,self.update(1,self.value)}))}).bind("close",function(e){var win=self.window,preview=self.preview.trigger("change"),file=self.value,node=cwd.find("#"+win.data("hash")),close=function(){state=closed,win.hide(),preview.children().remove(),self.update(0,self.value)};self.opened()&&(state=animated,win.is("."+fullscreen)&&fsicon.mousedown(),node.length?win.animate(closedCss(node),500,close):close())}),this.alwaysEnabled=!0,this.value=null,this.handlers={select:function(){this.update(void 0,this.fm.selectedFiles()[0])},error:function(){self.window.is(":visible")&&self.window.data("hash","").trigger("close")},"searchshow searchhide":function(){this.opened()&&this.window.trigger("close")}},this.shortcuts=[{pattern:"space"}],this.support={audio:{ogg:support('audio/ogg; codecs="vorbis"'),mp3:support("audio/mpeg;"),wav:support('audio/wav; codecs="1"'),m4a:support("audio/x-m4a;")||support("audio/aac;")},video:{ogg:support('video/ogg; codecs="theora"'),webm:support('video/webm; codecs="vp8, vorbis"'),mp4:support('video/mp4; codecs="avc1.42E01E"')||support('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')}},this.closed=function(){return state==closed},this.opened=function(){return state==opened},this.init=function(){var o=this.options,win=this.window,preview=this.preview,i,p;width=o.width>0?parseInt(o.width):450,height=o.height>0?parseInt(o.height):300,fm.one("load",function(){parent=fm.getUI(),cwd=fm.getUI("cwd"),win.appendTo("body").zIndex(100+parent.zIndex()),$(document).keydown(function(e){e.keyCode==27&&self.opened()&&win.trigger("close")}),$.fn.resizable&&win.resizable({handles:"se",minWidth:350,minHeight:120,resize:function(){preview.trigger("changesize")}}),self.change(function(){self.opened()&&(self.value?preview.trigger($.Event("update",{file:self.value})):win.trigger("close"))}),$.each(fm.commands.quicklook.plugins||[],function(i,plugin){typeof plugin=="function"&&new plugin(self)}),preview.bind("update",function(){self.info.show()})})},this.getstate=function(){return this.fm.selected().length==1?state==opened?1:0:-1},this.exec=function(){this.enabled()&&this.window.trigger(this.opened()?"close":"open")},this.hideinfo=function(){this.info.stop(!0).hide()}},elFinder.prototype.commands.quicklook.plugins=[function(ql){var mimes=["image/jpeg","image/png","image/gif"],preview=ql.preview;$.each(navigator.mimeTypes,function(i,o){var mime=o.type;mime.indexOf("image/")===0&&$.inArray(mime,mimes)&&mimes.push(mime)}),preview.bind("update",function(e){var file=e.file,img;$.inArray(file.mime,mimes)!==-1&&(e.stopImmediatePropagation(),img=$("<img/>").hide().appendTo(preview).load(function(){setTimeout(function(){var prop=(img.width()/img.height()).toFixed(2);preview.bind("changesize",function(){var pw=parseInt(preview.width()),ph=parseInt(preview.height()),w,h;prop<(pw/ph).toFixed(2)?(h=ph,w=Math.floor(h*prop)):(w=pw,h=Math.floor(w/prop)),img.width(w).height(h).css("margin-top",h<ph?Math.floor((ph-h)/2):0)}).trigger("changesize"),ql.hideinfo(),img.fadeIn(100)},1)}).attr("src",ql.fm.url(file.hash)))})},function(ql){var mimes=["text/html","application/xhtml+xml"],preview=ql.preview,fm=ql.fm;preview.bind("update",function(e){var file=e.file,jqxhr;$.inArray(file.mime,mimes)!==-1&&(e.stopImmediatePropagation(),preview.one("change",function(){!jqxhr.isResolved()&&!jqxhr.isRejected()&&jqxhr.reject()}),jqxhr=fm.request({data:{cmd:"get",target:file.hash,current:file.phash},preventDefault:!0}).done(function(data){ql.hideinfo(),doc=$('<iframe class="elfinder-quicklook-preview-html"/>').appendTo(preview)[0].contentWindow.document,doc.open(),doc.write(data.content),doc.close()}))})},function(ql){var fm=ql.fm,mimes=fm.res("mimes","text"),preview=ql.preview;preview.bind("update",function(e){var file=e.file,mime=file.mime,jqxhr;if(mime.indexOf("text/")===0||$.inArray(mime,mimes)!==-1)e.stopImmediatePropagation(),preview.one("change",function(){!jqxhr.isResolved()&&!jqxhr.isRejected()&&jqxhr.reject()}),jqxhr=fm.request({data:{cmd:"get",target:file.hash},preventDefault:!0}).done(function(data){ql.hideinfo(),$('<div class="elfinder-quicklook-preview-text-wrapper"><pre class="elfinder-quicklook-preview-text">'+fm.escape(data.content)+"</pre></div>").appendTo(preview)})})},function(ql){var fm=ql.fm,mime="application/pdf",preview=ql.preview,active=!1;$.browser.safari&&navigator.platform.indexOf("Mac")!=-1||$.browser.msie?active=!0:$.each(navigator.plugins,function(i,plugins){$.each(plugins,function(i,plugin){if(plugin.type==mime)return!(active=!0)})}),active&&preview.bind("update",function(e){var file=e.file,node;file.mime==mime&&(e.stopImmediatePropagation(),preview.one("change",function(){node.unbind("load").remove()}),node=$('<iframe class="elfinder-quicklook-preview-pdf"/>').hide().appendTo(preview).load(function(){ql.hideinfo(),node.show()}).attr("src",fm.url(file.hash)))})},function(ql){var fm=ql.fm,mime="application/x-shockwave-flash",preview=ql.preview,active=!1;$.each(navigator.plugins,function(i,plugins){$.each(plugins,function(i,plugin){if(plugin.type==mime)return!(active=!0)})}),active&&preview.bind("update",function(e){var file=e.file,node;file.mime==mime&&(e.stopImmediatePropagation(),ql.hideinfo(),preview.append(node=$('<embed class="elfinder-quicklook-preview-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+fm.url(file.hash)+'" quality="high" type="application/x-shockwave-flash" />')))})},function(ql){var preview=ql.preview,autoplay=!!ql.options.autoplay,mimes={"audio/mpeg":"mp3","audio/mpeg3":"mp3","audio/mp3":"mp3","audio/x-mpeg3":"mp3","audio/x-mp3":"mp3","audio/x-wav":"wav","audio/wav":"wav","audio/x-m4a":"m4a","audio/aac":"m4a","audio/mp4":"m4a","audio/x-mp4":"m4a","audio/ogg":"ogg"},node;preview.bind("update",function(e){var file=e.file,type=mimes[file.mime];ql.support.audio[type]&&(e.stopImmediatePropagation(),node=$('<audio class="elfinder-quicklook-preview-audio" controls preload="auto" autobuffer><source src="'+ql.fm.url(file.hash)+'" /></audio>').appendTo(preview),autoplay&&node[0].play())}).bind("change",function(){node&&node.parent().length&&(node[0].pause(),node.remove(),node=null)})},function(ql){var preview=ql.preview,autoplay=!!ql.options.autoplay,mimes={"video/mp4":"mp4","video/x-m4v":"mp4","video/ogg":"ogg","application/ogg":"ogg","video/webm":"webm"},node;preview.bind("update",function(e){var file=e.file,type=mimes[file.mime];ql.support.video[type]&&(e.stopImmediatePropagation(),ql.hideinfo(),node=$('<video class="elfinder-quicklook-preview-video" controls preload="auto" autobuffer><source src="'+ql.fm.url(file.hash)+'" /></video>').appendTo(preview),autoplay&&node[0].play())}).bind("change",function(){node&&node.parent().length&&(node[0].pause(),node.remove(),node=null)})},function(ql){var preview=ql.preview,mimes=[],node;$.each(navigator.plugins,function(i,plugins){$.each(plugins,function(i,plugin){(plugin.type.indexOf("audio/")===0||plugin.type.indexOf("video/")===0)&&mimes.push(plugin.type)})}),preview.bind("update",function(e){var file=e.file,mime=file.mime,video;$.inArray(file.mime,mimes)!==-1&&(e.stopImmediatePropagation(),(video=mime.indexOf("video/")===0)&&ql
.hideinfo(),node=$('<embed src="'+ql.fm.url(file.hash)+'" type="'+mime+'" class="elfinder-quicklook-preview-'+(video?"video":"audio")+'"/>').appendTo(preview))}).bind("change",function(){node&&node.parent().length&&(node.remove(),node=null)})}],elFinder.prototype.commands.reload=function(){this.alwaysEnabled=!0,this.updateOnSelect=!0,this.shortcuts=[{pattern:"ctrl+shift+r f5"}],this.getstate=function(){return 0},this.exec=function(){var fm=this.fm,dfrd=fm.sync(),timeout=setTimeout(function(){fm.notify({type:"reload",cnt:1,hideCnt:!0}),dfrd.always(function(){fm.notify({type:"reload",cnt:-1})})},fm.notifyDelay);return dfrd.always(function(){clearTimeout(timeout),fm.trigger("reload")})}},elFinder.prototype.commands.rename=function(){this.shortcuts=[{pattern:"f2"+(this.fm.OS=="mac"?" enter":"")}],this.getstate=function(){var sel=this.fm.selectedFiles();return!this._disabled&&sel.length==1&&sel[0].phash&&!sel[0].locked?0:-1},this.exec=function(){var fm=this.fm,cwd=fm.getUI("cwd"),sel=fm.selected(),cnt=sel.length,file=fm.file(sel.shift()),filename=".elfinder-cwd-filename",dfrd=$.Deferred().fail(function(error){var parent=input.parent(),name=fm.escape(file.name);parent.length?(input.remove(),parent.html(name)):(cwd.find("#"+file.hash).find(filename).html(name),setTimeout(function(){cwd.find("#"+file.hash).click()},50)),error&&fm.error(error)}).always(function(){fm.enable()}),input=$('<input type="text"/>').keydown(function(e){e.stopPropagation(),e.stopImmediatePropagation(),e.keyCode==$.ui.keyCode.ESCAPE?dfrd.reject():e.keyCode==$.ui.keyCode.ENTER&&input.blur()}).mousedown(function(e){e.stopPropagation()}).dblclick(function(e){e.stopPropagation(),e.preventDefault()}).blur(function(){var name=$.trim(input.val()),parent=input.parent();if(parent.length){input[0].setSelectionRange&&input[0].setSelectionRange(0,0);if(name==file.name)return dfrd.reject();if(!name)return dfrd.reject("errInvName");if(fm.fileByName(name,file.phash))return dfrd.reject(["errExists",name]);parent.html(fm.escape(name)),fm.lockfiles({files:[file.hash]}),fm.request({data:{cmd:"rename",target:file.hash,name:name},notify:{type:"rename",cnt:1}}).fail(function(error){dfrd.reject(),fm.sync()}).done(function(data){dfrd.resolve(data)}).always(function(){fm.unlockfiles({files:[file.hash]})})}}),node=cwd.find("#"+file.hash).find(filename).empty().append(input.val(file.name)),name=input.val().replace(/\.((tar\.(gz|bz|bz2|z|lzo))|cpio\.gz|ps\.gz|xcf\.(gz|bz2)|[a-z0-9]{1,4})$/ig,"");return this.disabled()?dfrd.reject():!file||cnt>1||!node.length?dfrd.reject("errCmdParams",this.title):file.locked?dfrd.reject(["errLocked",file.name]):(fm.one("select",function(){input.parent().length&&file&&$.inArray(file.hash,fm.selected())===-1&&input.blur()}),input.select().focus(),input[0].setSelectionRange&&input[0].setSelectionRange(0,name.length),dfrd)}},elFinder.prototype.commands.resize=function(){this.updateOnSelect=!1,this.getstate=function(){var sel=this.fm.selectedFiles();return!this._disabled&&sel.length==1&&sel[0].read&&sel[0].write&&sel[0].mime.indexOf("image/")!==-1?0:-1},this.exec=function(hashes){var fm=this.fm,files=this.files(hashes),dfrd=$.Deferred(),open=function(file,id){var dialog=$('<div class="elfinder-dialog-resize"/>'),input='<input type="text" size="5"/>',row='<div class="elfinder-resize-row"/>',label='<div class="elfinder-resize-label"/>',control=$('<div class="elfinder-resize-control"/>'),preview=$('<div class="elfinder-resize-preview"/>'),spinner=$('<div class="elfinder-resize-spinner">'+fm.i18n("ntfloadimg")+"</div>"),rhandle=$('<div class="elfinder-resize-handle"/>'),rhandlec=$('<div class="elfinder-resize-handle"/>'),uiresize=$('<div class="elfinder-resize-uiresize"/>'),uicrop=$('<div class="elfinder-resize-uicrop"/>'),uibuttonset='<div class="ui-widget-content ui-corner-all elfinder-buttonset"/>',uibutton='<div class="ui-state-default elfinder-button"/>',uiseparator='<span class="ui-widget-content elfinder-toolbar-button-separator"/>',uirotate=$('<div class="elfinder-resize-rotate"/>'),uideg270=$(uibutton).attr("title",fm.i18n("rotate-cw")).append($('<span class="elfinder-button-icon elfinder-button-icon-rotate-l"/>').click(function(){rdegree-=90,rotate.update(rdegree)})),uideg90=$(uibutton).attr("title",fm.i18n("rotate-ccw")).append($('<span class="elfinder-button-icon elfinder-button-icon-rotate-r"/>').click(function(){rdegree+=90,rotate.update(rdegree)})),uiprop=$("<span />"),reset=$('<div class="ui-state-default ui-corner-all elfinder-resize-reset"><span class="ui-icon ui-icon-arrowreturnthick-1-w"/></div>'),uitype=$('<div class="elfinder-resize-type"/>').append('<input type="radio" name="type" id="type-resize" value="resize" checked="checked" /><label for="type-resize">'+fm.i18n("resize")+"</label>").append('<input type="radio" name="type" id="type-crop"   value="crop"/><label for="type-crop">'+fm.i18n("crop")+"</label>").append('<input type="radio" name="type" id="type-rotate" value="rotate"/><label for="type-rotate">'+fm.i18n("rotate")+"</label>"),type=$("input",uitype).change(function(){var val=$("input:checked",uitype).val();resetView(),resizable(!0),croppable(!0),rotateable(!0),val=="resize"?(uiresize.show(),uirotate.hide(),uicrop.hide(),resizable()):val=="crop"?(uirotate.hide(),uiresize.hide(),uicrop.show(),croppable()):val=="rotate"&&(uiresize.hide(),uicrop.hide(),uirotate.show(),rotateable())}),constr=$('<input type="checkbox" checked="checked"/>').change(function(){cratio=!!constr.prop("checked"),resize.fixHeight(),resizable(!0),resizable()}),width=$(input).change(function(){var w=parseInt(width.val()),h=parseInt(cratio?w/ratio:height.val());w>0&&h>0&&(resize.updateView(w,h),height.val(h))}),height=$(input).change(function(){var h=parseInt(height.val()),w=parseInt(cratio?h*ratio:width.val());w>0&&h>0&&(resize.updateView(w,h),width.val(w))}),pointX=$(input),pointY=$(input),offsetX=$(input),offsetY=$(input),degree=$('<input type="text" size="3" maxlength="3" value="0" />').change(function(){rotate.update()}),uidegslider=$('<div class="elfinder-resize-rotate-slider"/>').slider({min:0,max:359,value:degree.val(),animate:!0,change:function(event,ui){ui.value!=uidegslider.slider("value")&&rotate.update(ui.value)},slide:function(event,ui){rotate.update(ui.value,!1)}}),ratio=1,prop=1,owidth=0,oheight=0,cratio=!0,pwidth=0,pheight=0,rwidth=0,rheight=0,rdegree=0,img=$("<img/>").load(function(){spinner.remove(),owidth=img.width(),oheight=img.height(),ratio=owidth/oheight,resize.updateView(owidth,oheight),rhandle.append(img.show()).show(),width.val(owidth),height.val(oheight);var r_scale=Math.min(pwidth,pheight)/Math.sqrt(Math.pow(owidth,2)+Math.pow(oheight,2));rwidth=owidth*r_scale,rheight=oheight*r_scale,control.find("input,select").removeAttr("disabled").filter(":text").keydown(function(e){var c=e.keyCode,i;e.stopPropagation();if(c>=37&&c<=40||c==$.ui.keyCode.BACKSPACE||c==$.ui.keyCode.DELETE||c==65&&(e.ctrlKey||e.metaKey)||c==27)return;c==9&&(i=$(this).parent()[e.shiftKey?"prev":"next"](".elfinder-resize-row").children(":text"),i.length&&i.focus());if(c==13){save();return}(c<48||c>57)&&e.preventDefault()}).filter(":first").focus(),resizable(),reset.hover(function(){reset.toggleClass("ui-state-hover")}).click(resetView)}).error(function(){spinner.text("Unable to load image").css("background","transparent")}),basec=$("<div/>"),imgc=$("<img/>"),coverc=$("<div/>"),imgr=$("<img/>"),resetView=function(){width.val(owidth),height.val(oheight),resize.updateView(owidth,oheight)},resize={update:function(){width.val(parseInt(img.width()/prop)),height.val(parseInt(img.height()/prop))},updateView:function(w,h){w>pwidth||h>pheight?w/pwidth>h/pheight?img.width(pwidth).height(Math.ceil(img.width()/ratio)):img.height(pheight).width(Math.ceil(img.height()*ratio)):img.width(w).height(h),prop=img.width()/w,uiprop.text("1 : "+(1/prop).toFixed(2)),resize.updateHandle()},updateHandle:function(){rhandle.width(img.width()).height(img.height())},fixWidth:function(){var w,h;cratio&&(h=height.val(),h=parseInt(h*ratio),resize.updateView(w,h),width.val(w))},fixHeight:function(){var w,h;cratio&&(w=width.val(),h=parseInt(w/ratio),resize.updateView(w,h),height.val(h))}},crop={update:function(){offsetX
.val(parseInt(rhandlec.width()/prop)),offsetY.val(parseInt(rhandlec.height()/prop)),pointX.val(parseInt((rhandlec.offset().left-imgc.offset().left)/prop)),pointY.val(parseInt((rhandlec.offset().top-imgc.offset().top)/prop))},resize_update:function(){crop.update(),coverc.width(rhandlec.width()),coverc.height(rhandlec.height())}},rotate={mouseStartAngle:0,imageStartAngle:0,imageBeingRotated:!1,update:function(value,animate){typeof value=="undefined"&&(rdegree=value=parseInt(degree.val())),typeof animate=="undefined"&&(animate=!0),!animate||$.browser.opera||$.browser.msie&&parseInt($.browser.version)<9?imgr.rotate(value):imgr.animate({rotate:value+"deg"}),value%=360,value<0&&(value+=360),degree.val(parseInt(value)),uidegslider.slider("value",degree.val())},execute:function(e){if(!rotate.imageBeingRotated)return;var imageCentre=rotate.getCenter(imgr),mouseXFromCentre=e.pageX-imageCentre[0],mouseYFromCentre=e.pageY-imageCentre[1],mouseAngle=Math.atan2(mouseYFromCentre,mouseXFromCentre),rotateAngle=mouseAngle-rotate.mouseStartAngle+rotate.imageStartAngle;return rotateAngle=Math.round(parseFloat(rotateAngle)*180/Math.PI),e.shiftKey&&(rotateAngle=Math.round((rotateAngle+6)/15)*15),imgr.rotate(rotateAngle),rotateAngle%=360,rotateAngle<0&&(rotateAngle+=360),degree.val(rotateAngle),uidegslider.slider("value",degree.val()),!1},start:function(e){rotate.imageBeingRotated=!0;var imageCentre=rotate.getCenter(imgr),mouseStartXFromCentre=e.pageX-imageCentre[0],mouseStartYFromCentre=e.pageY-imageCentre[1];return rotate.mouseStartAngle=Math.atan2(mouseStartYFromCentre,mouseStartXFromCentre),rotate.imageStartAngle=parseFloat(imgr.rotate())*Math.PI/180,$(document).mousemove(rotate.execute),!1},stop:function(e){if(!rotate.imageBeingRotated)return;return $(document).unbind("mousemove",rotate.execute),setTimeout(function(){rotate.imageBeingRotated=!1},10),!1},getCenter:function(image){var currentRotation=imgr.rotate();imgr.rotate(0);var imageOffset=imgr.offset(),imageCentreX=imageOffset.left+imgr.width()/2,imageCentreY=imageOffset.top+imgr.height()/2;return imgr.rotate(currentRotation),Array(imageCentreX,imageCentreY)}},resizable=function(destroy){$.fn.resizable&&(destroy?(rhandle.resizable("destroy"),rhandle.hide()):(rhandle.show(),rhandle.resizable({alsoResize:img,aspectRatio:cratio,resize:resize.update,stop:resize.fixHeight})))},croppable=function(destroy){$.fn.draggable&&$.fn.resizable&&(destroy?(rhandlec.resizable("destroy"),rhandlec.draggable("destroy"),basec.hide()):(imgc.width(img.width()).height(img.height()),coverc.width(img.width()).height(img.height()),rhandlec.width(imgc.width()).height(imgc.height()).offset(imgc.offset()).resizable({containment:basec,resize:crop.resize_update,handles:"all"}).draggable({handle:rhandlec,containment:imgc,drag:crop.update}),basec.show().width(img.width()).height(img.height()),crop.update()))},rotateable=function(destroy){$.fn.draggable&&$.fn.resizable&&(destroy?imgr.hide():imgr.show().width(rwidth).height(rheight).css("margin-top",(pheight-rheight)/2+"px").css("margin-left",(pwidth-rwidth)/2+"px"))},save=function(){var w,h,x,y,d,mode=$("input:checked",uitype).val();width.add(height).change();if(mode=="resize")w=parseInt(width.val())||0,h=parseInt(height.val())||0;else if(mode=="crop")w=parseInt(offsetX.val())||0,h=parseInt(offsetY.val())||0,x=parseInt(pointX.val())||0,y=parseInt(pointY.val())||0;else if(mode="rotate"){w=owidth,h=oheight,d=parseInt(degree.val())||0;if(d<0||d>360)return fm.error("Invalid rotate degree");if(d==0||d==360)return fm.error("Image dose not rotated")}if(mode!="rotate"){if(w<=0||h<=0)return fm.error("Invalid image size");if(w==owidth&&h==oheight)return fm.error("Image size not changed")}dialog.elfinderdialog("close"),fm.request({data:{cmd:"resize",target:file.hash,width:w,height:h,x:x,y:y,degree:d,mode:mode},notify:{type:"resize",cnt:1}}).fail(function(error){dfrd.reject(error)}).done(function(){dfrd.resolve()})},buttons={},hline="elfinder-resize-handle-hline",vline="elfinder-resize-handle-vline",rpoint="elfinder-resize-handle-point",src=fm.url(file.hash);imgr.mousedown(rotate.start),$(document).mouseup(rotate.stop),uiresize.append($(row).append($(label).text(fm.i18n("width"))).append(width).append(reset)).append($(row).append($(label).text(fm.i18n("height"))).append(height)).append($(row).append($("<label/>").text(fm.i18n("aspectRatio")).prepend(constr))).append($(row).append(fm.i18n("scale")+" ").append(uiprop)),uicrop.append($(row).append($(label).text("X")).append(pointX)).append($(row).append($(label).text("Y")).append(pointY)).append($(row).append($(label).text(fm.i18n("width"))).append(offsetX)).append($(row).append($(label).text(fm.i18n("height"))).append(offsetY)),uirotate.append($(row).append($(label).text(fm.i18n("rotate"))).append($('<div style="float:left; width: 130px;">').append($('<div style="float:left;">').append(degree).append($("<span/>").text(fm.i18n("degree")))).append($(uibuttonset).append(uideg270).append($(uiseparator)).append(uideg90))).append(uidegslider)),dialog.append(uitype),control.append($(row)).append(uiresize).append(uicrop.hide()).append(uirotate.hide()).find("input,select").attr("disabled","disabled"),rhandle.append('<div class="'+hline+" "+hline+'-top"/>').append('<div class="'+hline+" "+hline+'-bottom"/>').append('<div class="'+vline+" "+vline+'-left"/>').append('<div class="'+vline+" "+vline+'-right"/>').append('<div class="'+rpoint+" "+rpoint+'-e"/>').append('<div class="'+rpoint+" "+rpoint+'-se"/>').append('<div class="'+rpoint+" "+rpoint+'-s"/>'),preview.append(spinner).append(rhandle.hide()).append(img.hide()),rhandlec.css("position","absolute").append('<div class="'+hline+" "+hline+'-top"/>').append('<div class="'+hline+" "+hline+'-bottom"/>').append('<div class="'+vline+" "+vline+'-left"/>').append('<div class="'+vline+" "+vline+'-right"/>').append('<div class="'+rpoint+" "+rpoint+'-n"/>').append('<div class="'+rpoint+" "+rpoint+'-e"/>').append('<div class="'+rpoint+" "+rpoint+'-s"/>').append('<div class="'+rpoint+" "+rpoint+'-w"/>').append('<div class="'+rpoint+" "+rpoint+'-ne"/>').append('<div class="'+rpoint+" "+rpoint+'-se"/>').append('<div class="'+rpoint+" "+rpoint+'-sw"/>').append('<div class="'+rpoint+" "+rpoint+'-nw"/>'),preview.append(basec.css("position","absolute").hide().append(imgc).append(rhandlec.append(coverc))),preview.append(imgr.hide()),preview.css("overflow","hidden"),dialog.append(preview).append(control),buttons[fm.i18n("btnCancel")]=function(){dialog.elfinderdialog("close")},buttons[fm.i18n("btnApply")]=save,fm.dialog(dialog,{title:file.name,width:650,resizable:!1,destroyOnClose:!0,buttons:buttons,open:function(){preview.zIndex(1+$(this).parent().zIndex())}}).attr("id",id),$.browser.msie&&parseInt($.browser.version)<9&&$(".elfinder-dialog").css("filter",""),reset.css("left",width.position().left+width.width()+12),coverc.css({opacity:.2,"background-color":"#fff",position:"absolute"}),rhandlec.css("cursor","move"),rhandlec.find(".elfinder-resize-handle-point").css({"background-color":"#fff",opacity:.5,"border-color":"#000"}),imgr.css("cursor","pointer"),uitype.buttonset(),pwidth=preview.width()-(rhandle.outerWidth()-rhandle.width()),pheight=preview.height()-(rhandle.outerHeight()-rhandle.height()),img.attr("src",src+(src.indexOf("?")===-1?"?":"&")+"_="+Math.random()),imgc.attr("src",img.attr("src")),imgr.attr("src",img.attr("src"))},id,dialog;return!files.length||files[0].mime.indexOf("image/")===-1?dfrd.reject():(id="resize-"+fm.namespace+"-"+files[0].hash,dialog=fm.getUI().find("#"+id),dialog.length?(dialog.elfinderdialog("toTop"),dfrd.resolve()):(open(files[0],id),dfrd))}},function($){var findProperty=function(styleObject,styleArgs){var i=0;for(i in styleArgs)if(typeof styleObject[styleArgs[i]]!="undefined")return styleArgs[i];return styleObject[styleArgs[i]]="",styleArgs[i]};$.cssHooks.rotate={get:function(elem,computed,extra){return $(elem).rotate()},set:function(elem,value){return $(elem).rotate(value),value}},$.cssHooks.transform={get:function(elem,computed,extra){var name=findProperty(elem.style,["WebkitTransform","MozTransform","OTransform","msTransform","transform"]);return elem.style[name]},set:function(elem,value){var name=
findProperty(elem.style,["WebkitTransform","MozTransform","OTransform","msTransform","transform"]);return elem.style[name]=value,value}},$.fn.rotate=function(val){if(typeof val=="undefined"){if($.browser.opera){var r=this.css("transform").match(/rotate\((.*?)\)/);return r&&r[1]?Math.round(parseFloat(r[1])*180/Math.PI):0}var r=this.css("transform").match(/rotate\((.*?)\)/);return r&&r[1]?parseInt(r[1]):0}return this.css("transform",this.css("transform").replace(/none|rotate\(.*?\)/,"")+"rotate("+parseInt(val)+"deg)"),this},$.fx.step.rotate=function(fx){fx.state==0&&(fx.start=$(fx.elem).rotate(),fx.now=fx.start),$(fx.elem).rotate(fx.now)};if($.browser.msie&&parseInt($.browser.version)<9){var GetAbsoluteXY=function(element){var pnode=element,x=pnode.offsetLeft,y=pnode.offsetTop;while(pnode.offsetParent){pnode=pnode.offsetParent;if(pnode!=document.body&&pnode.currentStyle["position"]!="static")break;pnode!=document.body&&pnode!=document.documentElement&&(x-=pnode.scrollLeft,y-=pnode.scrollTop),x+=pnode.offsetLeft,y+=pnode.offsetTop}return{x:x,y:y}},StaticToAbsolute=function(element){if(element.currentStyle["position"]!="static")return;var xy=GetAbsoluteXY(element);element.style.position="absolute",element.style.left=xy.x+"px",element.style.top=xy.y+"px"},IETransform=function(element,transform){var r,m11=1,m12=1,m21=1,m22=1;if(typeof element.style["msTransform"]!="undefined")return!0;StaticToAbsolute(element),r=transform.match(/rotate\((.*?)\)/);var rotate=r&&r[1]?parseInt(r[1]):0;rotate%=360,rotate<0&&(rotate=360+rotate);var radian=rotate*Math.PI/180,cosX=Math.cos(radian),sinY=Math.sin(radian);m11*=cosX,m12*=-sinY,m21*=sinY,m22*=cosX,element.style.filter=(element.style.filter||"").replace(/progid:DXImageTransform\.Microsoft\.Matrix\([^)]*\)/,"")+("progid:DXImageTransform.Microsoft.Matrix(M11="+m11+",M12="+m12+",M21="+m21+",M22="+m22+",FilterType='bilinear',sizingMethod='auto expand')");var ow=parseInt(element.style.width||element.width||0),oh=parseInt(element.style.height||element.height||0),radian=rotate*Math.PI/180,absCosX=Math.abs(Math.cos(radian)),absSinY=Math.abs(Math.sin(radian)),dx=(ow-(ow*absCosX+oh*absSinY))/2,dy=(oh-(ow*absSinY+oh*absCosX))/2;return element.style.marginLeft=Math.floor(dx)+"px",element.style.marginTop=Math.floor(dy)+"px",!0},transform_set=$.cssHooks.transform.set;$.cssHooks.transform.set=function(elem,value){return transform_set.apply(this,[elem,value]),IETransform(elem,value),value}}}(jQuery),elFinder.prototype.commands.rm=function(){this.shortcuts=[{pattern:"delete ctrl+backspace"}],this.getstate=function(sel){var fm=this.fm;return sel=sel||fm.selected(),!this._disabled&&sel.length&&$.map(sel,function(h){var f=fm.file(h);return f&&f.phash&&!f.locked?h:null}).length==sel.length?0:-1},this.exec=function(hashes){var self=this,fm=this.fm,dfrd=$.Deferred().fail(function(error){error&&fm.error(error)}),files=this.files(hashes),cnt=files.length,cwd=fm.cwd().hash,goroot=!1;return!cnt||this._disabled?dfrd.reject():($.each(files,function(i,file){if(!file.phash)return!dfrd.reject(["errRm",file.name,"errPerm"]);if(file.locked)return!dfrd.reject(["errLocked",file.name]);file.hash==cwd&&(goroot=fm.root(file.hash))}),dfrd.isRejected()||(files=this.hashes(hashes),fm.confirm({title:self.title,text:"confirmRm",accept:{label:"btnRm",callback:function(){fm.lockfiles({files:files}),fm.request({data:{cmd:"rm",targets:files},notify:{type:"rm",cnt:cnt},preventFail:!0}).fail(function(error){dfrd.reject(error)}).done(function(data){dfrd.done(data),goroot&&fm.exec("open",goroot)}).always(function(){fm.unlockfiles({files:files})})}},cancel:{label:"btnCancel",callback:function(){dfrd.reject()}}})),dfrd)}},elFinder.prototype.commands.search=function(){this.title="Find files",this.options={ui:"searchbutton"},this.alwaysEnabled=!0,this.updateOnSelect=!1,this.getstate=function(){return 0},this.exec=function(q){var fm=this.fm;return typeof q=="string"&&q?(fm.trigger("searchstart",{query:q}),fm.request({data:{cmd:"search",q:q},notify:{type:"search",cnt:1,hideCnt:!0}})):(fm.getUI("toolbar").find("."+fm.res("class","searchbtn")+" :text").focus(),$.Deferred().reject())}},elFinder.prototype.commands.sort=function(){var self=this,sorts=["nameDirsFirst","kindDirsFirst","sizeDirsFirst","dateDirsFirst","name","kind","size","date"],i;this.options={ui:"sortbutton"},this.value=sorts[0],this.variants=[];for(i=0;i<sorts.length;i++)this.variants.push([sorts[i],this.fm.i18n("sort"+sorts[i])]);this.fm.bind("load sortchange",function(){self.value=sorts[self.fm.sort-1],self.change()}),this.getstate=function(){return 0},this.exec=function(hashes,type){var dir=$.inArray(type,sorts)+1==this.fm.sort?this.fm.sortDirect=="asc"?"desc":"asc":this.fm.sortDirect;return this.fm.setSort(type,dir),$.Deferred().resolve()}},elFinder.prototype.commands.up=function(){this.alwaysEnabled=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"ctrl+up"}],this.getstate=function(){return this.fm.cwd().phash?0:-1},this.exec=function(){return this.fm.cwd().phash?this.fm.exec("open",this.fm.cwd().phash):$.Deferred().reject()}},elFinder.prototype.commands.upload=function(){var hover=this.fm.res("class","hover");this.disableOnSearch=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"ctrl+u"}],this.getstate=function(){return!this._disabled&&this.fm.cwd().write?0:-1},this.exec=function(data){var fm=this.fm,upload=function(data){dialog.elfinderdialog("close"),fm.upload(data).fail(function(error){dfrd.reject(error)}).done(function(data){dfrd.resolve(data)})},dfrd,dialog,input,button,dropbox;return this.disabled()?$.Deferred().reject():data&&(data.input||data.files)?fm.upload(data):(dfrd=$.Deferred(),input=$('<input type="file" multiple="true"/>').change(function(){upload({input:input[0]})}),button=$('<div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"><span class="ui-button-text">'+fm.i18n("selectForUpload")+"</span></div>").append($("<form/>").append(input)).hover(function(){button.toggleClass(hover)}),dialog=$('<div class="elfinder-upload-dialog-wrapper"/>').append(button),fm.dragUpload&&(dropbox=$('<div class="ui-corner-all elfinder-upload-dropbox">'+fm.i18n("dropFiles")+"</div>").prependTo(dialog).after('<div class="elfinder-upload-dialog-or">'+fm.i18n("or")+"</div>")[0],dropbox.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault(),$(dropbox).addClass(hover)},!1),dropbox.addEventListener("dragleave",function(e){e.stopPropagation(),e.preventDefault(),$(dropbox).removeClass(hover)},!1),dropbox.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),dropbox.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),upload({files:e.dataTransfer.files})},!1)),fm.dialog(dialog,{title:this.title,modal:!0,resizable:!1,destroyOnClose:!0}),dfrd)}},elFinder.prototype.commands.view=function(){this.value=this.fm.viewType,this.alwaysEnabled=!0,this.updateOnSelect=!1,this.options={ui:"viewbutton"},this.getstate=function(){return 0},this.exec=function(){var value=this.fm.storage("view",this.value=="list"?"icons":"list");this.fm.viewchange(),this.update(void 0,value)}}})(jQuery)